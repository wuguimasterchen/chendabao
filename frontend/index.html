<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è”ææŠ•ç ”-è‚¡ç¥¨å®šæŠ•åŠ©æ‰‹</title>
  <style>
    /* å…¨å±€æ ·å¼é‡ç½®ä¸åŸºç¡€è®¾ç½® */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", "PingFang SC", "SF Pro Display", Arial, sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* ä¸æ»‘è¿‡æ¸¡ */
    }

    /* å¹³æ»‘æ»šåŠ¨ */
    html {
      scroll-behavior: smooth;
      /* æ–°å¢ï¼šä¸ºå›ºå®šçª—æ ¼é¢„ç•™é¡¶éƒ¨ç©ºé—´ */
      padding-top: 60px;
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(52, 152, 219, 0.05);
      border-radius: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #3498db, #2980b9);
      border-radius: 8px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #2980b9, #1f618d);
      background-clip: content-box;
    }

    /* èƒŒæ™¯æ¸å˜ */
    body {
      background: linear-gradient(135deg, #f0f4f8 0%, #e8f0fe 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto; /* è°ƒæ•´marginï¼Œé¿å…å’Œå›ºå®šçª—æ ¼é‡å  */
      padding: 20px 20px 40px;
    }

    /* æ ‡é¢˜æ¸å˜æ–‡å­—ç‰¹æ•ˆ */
    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      position: relative;
      background: linear-gradient(135deg, #3498db, #9b59b6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    h1::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 4px;
      background: linear-gradient(90deg, #3498db, #9b59b6);
      border-radius: 2px;
    }

    /* æ–°å¢ï¼šLogoæ ·å¼ */
    .logo-img {
      width: 200px;
      height: 200px;
      vertical-align: middle;
      margin-right: 10px;
      border-radius: 8px; /* è½»å¾®åœ†è§’ï¼Œæå‡ç¾è§‚åº¦ */
    }

    h3 {
      color: #2c3e50;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 30px 0 20px;
      display: flex;
      align-items: center;
      position: relative;
      padding-left: 10px;
    }

    h3::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 24px;
      background: linear-gradient(180deg, #3498db, #9b59b6);
      margin-right: 10px;
      border-radius: 3px;
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
    }

    h4 {
      color: #34495e;
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 20px;
      position: relative;
    }

    /* ç­–ç•¥è¯´æ˜ç»ç’ƒæ‹Ÿæ€æç¤ºæ¡† */
    .strategy-tip {
      color: #27ae60;
      font-weight: 500;
      margin: 40px 0 30px;
      padding: 15px 25px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.9);
      border-left: 4px solid #27ae60;
      border-radius: 10px;
      font-size: 1rem;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }

    /* ç‚«é…·æŒ‰é’®æ ·å¼ */
    .btn {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      padding: 14px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 15px 0;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      position: relative;
      overflow: hidden;
      /* ä¿®æ”¹ï¼šç§»é™¤max-widthï¼Œè®©æŒ‰é’®å®½åº¦è‡ªé€‚åº”å®¹å™¨ */
      width: 100%;
    }

    .btn::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: all 0.6s ease;
    }

    .btn:hover {
      background: linear-gradient(135deg, #2980b9 0%, #1f618d 100%);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
      transform: translateY(-2px);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:disabled {
      background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn:disabled::before {
      display: none;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* æ—¥å¿—åŒºåŸŸ - éšè—ï¼ˆä¸å†å‰ç«¯æ˜¾ç¤ºï¼‰ */
    .log-area {
      display: none !important; /* å¼ºåˆ¶éšè—æ—¥å¿—åŒºåŸŸ */
      height: 220px;
      border: 1px solid rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      padding: 20px;
      margin: 25px 0;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.7;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
      font-family: "Consolas", "Monaco", "Fira Code", monospace;
      position: relative;
    }

    /* å›¾è¡¨åŒºåŸŸ - ç‚«é…·å¡ç‰‡ */
    .chart-area {
      margin: 35px 0;
      height: 600px;
      width: 100%;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(31, 38, 135, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.9);
      position: relative;
      overflow: hidden;
    }

    .chart-area::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #3498db, #9b59b6, #3498db);
      background-size: 200% 100%;
      animation: gradientMove 5s ease infinite;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* åˆå¹¶åçš„é…ç½®ä¸»å®¹å™¨ */
    .main-config-area {
      margin: 30px 0;
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.8);
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }

    /* é…ç½®åˆ†åŒºæ ·å¼ */
    .config-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(222, 226, 230, 0.5);
    }

    .config-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    /* Flexå¸ƒå±€å®¹å™¨ï¼ˆå®ç°å¹¶æ’ï¼‰ */
    .strategy-flex-container {
      display: flex;
      flex-wrap: wrap; /* è‡ªåŠ¨æ¢è¡Œï¼ˆé€‚é…å°å±ï¼‰ */
      gap: 30px; /* å¢åŠ é—´è·ï¼Œæå‡è§†è§‰æ•ˆæœ */
      align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
      position: relative;
    }

    /* åŸºç¡€ç­–ç•¥å‚æ•°å®¹å™¨ï¼ˆå·¦ä¾§ï¼‰ */
    .strategy-basic-container {
      flex: 1; /* ç­‰å®½åˆ†é… */
      min-width: 300px; /* æœ€å°å®½åº¦ï¼Œé˜²æ­¢ç¼©å¾—å¤ªçª„ */
    }

    /* åŠ¨æ€ä¼°å€¼æ­¢ç›ˆå‚æ•°å®¹å™¨ï¼ˆå³ä¾§ï¼‰- ä¿®æ”¹åæ ·å¼ */
    .strategy-valuation-container {
      flex: 1; /* ç­‰å®½åˆ†é… */
      min-width: 300px; /* å’Œå·¦ä¾§ä¿æŒä¸€è‡´çš„æœ€å°å®½åº¦ */
      padding: 0; /* ç§»é™¤å†…è¾¹è·ï¼Œå’Œå·¦ä¾§ä¿æŒä¸€è‡´ */
      border: 1px solid rgba(220, 220, 220, 0.8); /* ç°è‰²è¾¹æ¡†ä¿ç•™ */
      border-radius: 12px;
      background: rgba(245, 245, 245, 0.9); /* æµ…ç°è‰²èƒŒæ™¯ä¿ç•™ */
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 20px rgba(31, 38, 135, 0.08);
      /* å…³é”®ä¿®æ”¹ï¼šç§»é™¤å¯¼è‡´åç§»çš„å±æ€§ */
      margin-left: 0 !important;
      transform: none !important;
      /* å¢åŠ å†…è¾¹è·ï¼Œä¿æŒå†…éƒ¨å¸ƒå±€ */
      padding: 20px;
    }

    /* é…ç½®é¡¹ - ä¼˜åŒ–é˜²æ­¢è½¬è¡Œ */
    .config-item {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 20px;
      white-space: nowrap; /* é˜²æ­¢æ•´è¡Œè½¬è¡Œ */
    }

    .config-item label {
      width: 180px;
      text-align: right;
      font-weight: 500;
      color: #2c3e50;
      font-size: 15px;
      white-space: nowrap; /* æ ‡ç­¾ä¸è½¬è¡Œ */
    }

    /* ç‚«é…·è¾“å…¥æ¡† - ç»Ÿä¸€æ‰€æœ‰è¾“å…¥æ¡†æ ·å¼ï¼ˆåŒ…æ‹¬æ—¶é—´é€‰æ‹©æ¡†ï¼‰ */
    .config-item input,
    .stock-info-item input,
    .autocomplete input {
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      width: 200px;
      min-width: 180px; /* æœ€å°å®½åº¦ï¼Œé˜²æ­¢è½¬è¡Œ */
      font-size: 14px;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      white-space: nowrap; /* è¾“å…¥æ¡†å†…å®¹ä¸è½¬è¡Œ */
      /* ç»Ÿä¸€æ—¶é—´é€‰æ‹©æ¡†çš„é«˜åº¦å’Œæ ·å¼ */
      height: 46px;
      line-height: 1;
    }

    /* æ‰€æœ‰è¾“å…¥æ¡†çš„focusæ•ˆæœç»Ÿä¸€ */
    .config-item input:focus,
    .stock-info-item input:focus,
    .autocomplete input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.15), 0 4px 10px rgba(52, 152, 219, 0.1);
      transform: translateY(-1px);
    }

    /* è‡ªåŠ¨è¡¥å…¨æ ·å¼å‡çº§ - ç»Ÿä¸€é£æ ¼ */
    .autocomplete {
      position: relative;
      display: inline-block;
      width: 200px;
      min-width: 180px; /* æœ€å°å®½åº¦ï¼Œå’Œè¾“å…¥æ¡†ç»Ÿä¸€ */
    }

    .autocomplete-items {
      position: absolute;
      border: 1px solid rgba(255, 255, 255, 0.9);
      border-bottom: none;
      border-top: none;
      z-index: 999;
      top: 100%;
      left: 0;
      right: 0;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 10px 30px rgba(31, 38, 135, 0.15);
      overflow: hidden;
    }

    .autocomplete-items div {
      padding: 14px 18px;
      cursor: pointer;
      background-color: rgba(255, 255, 255, 0.95);
      border-bottom: 1px solid #e9ecef;
      font-size: 14px;
    }

    .autocomplete-items div:hover {
      background-color: #f1f8fe;
      transform: translateX(3px);
    }

    .autocomplete-active {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
      color: #ffffff;
    }

    /* ç»“æœæ±‡æ€» - ç”°å­—æ ¼å¸ƒå±€ */
    .result-summary {
      margin: 30px 0;
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.8);
      border-radius: 15px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(240, 248, 255, 0.9) 100%);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(31, 38, 135, 0.15);
      position: relative;
      overflow: hidden;
    }

    .result-summary::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(52, 152, 219, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(50%, -50%);
      z-index: 0;
    }

    .result-summary h4 {
      margin-bottom: 25px;
      color: #2c3e50;
      font-size: 1.4rem;
      position: relative;
      z-index: 1;
    }

    /* ç”°å­—æ ¼å®¹å™¨ */
    .result-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      position: relative;
      z-index: 1;
    }

    /* ç”°å­—æ ¼é¡¹ç›® */
    .result-card {
      padding: 25px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(31, 38, 135, 0.1);
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    .result-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(31, 38, 135, 0.15);
    }

    .result-card .strategy-name {
      font-weight: 700;
      background: linear-gradient(135deg, #3498db, #9b59b6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 15px;
      font-size: 1.2rem;
      border-bottom: 1px solid rgba(222, 226, 230, 0.5);
      padding-bottom: 10px;
    }

    .result-card .result-metric {
      margin: 10px 0;
      color: #495057;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .result-card .result-metric .value {
      font-weight: 600;
      color: #2c3e50;
      font-size: 16px;
    }

    /* éšè—ç±» */
    .hidden {
      display: none;
    }

    /* æ•°æ®æ ‡ç­¾é¡µæ ·å¼ï¼ˆç‚«é…·ç‰ˆï¼‰ */
    .data-source-tabs {
      display: flex;
      margin-bottom: 25px;
      gap: 15px;
    }

    .data-source-tab {
      padding: 12px 25px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 10px rgba(31, 38, 135, 0.08);
    }

    .data-source-tab.active {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: #fff;
      box-shadow: 0 6px 15px rgba(52, 152, 219, 0.2);
    }

    /* ç™»å½•å¼¹çª—æ ·å¼ï¼ˆç›´æ¥éšè—ï¼Œä¸å†ä½¿ç”¨ï¼‰ */
    .login-modal {
      display: none !important;
    }

    /* ç™»å½•çŠ¶æ€æç¤ºï¼ˆç®€åŒ–ä¸ºçº¯æ¸¸å®¢æ¨¡å¼ï¼‰ */
    .login-status {
      text-align: right;
      margin-bottom: 10px;
      color: #2c3e50;
      font-size: 14px;
    }

    /* ç§¯åˆ†æ ·å¼ï¼ˆæ¸¸å®¢æ¨¡å¼éšè—ï¼‰ */
    .user-points {
      display: none;
      color: #e67e22;
      font-weight: 600;
      margin-left: 10px;
    }

    /* ========== æ–°å¢ï¼šè‚¡ç¥¨ä¿¡æ¯æ¨ªå‘æ’åˆ—æ ·å¼ ========== */
    .stock-info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      margin-bottom: 20px;
    }

    .stock-info-item {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 220px; /* å¢å¤§æœ€å°å®½åº¦ï¼Œä¼˜åŒ–å¸ƒå±€ */
    }

    .stock-info-item label {
      white-space: nowrap;
      font-weight: 500;
      color: #2c3e50;
      font-size: 15px;
      width: 90px; /* å›ºå®šæ ‡ç­¾å®½åº¦ï¼Œå¯¹é½æ›´ç¾è§‚ */
    }

    .stock-info-item .autocomplete,
    .stock-info-item input {
      width: 100%;
      flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
    }

    /* ========== æ ¸å¿ƒä¿®æ”¹ï¼šè‚¡ç¥¨åç§°æ˜¾ç¤ºåŒºåŸŸæ”¹ä¸ºå†»ç»“çª—æ ¼ ========== */
    .stock-name-display {
      /* å†»ç»“çª—æ ¼æ ¸å¿ƒæ ·å¼ */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 9999; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
      /* åŸæœ‰æ ·å¼ä¿ç•™å¹¶ä¼˜åŒ– */
      margin: 0;
      padding: 12px 20px;
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(155, 89, 182, 0.1) 100%);
      border-radius: 0; /* å–æ¶ˆåœ†è§’ï¼Œé€‚é…å…¨å± */
      border-left: 4px solid #3498db;
      border-bottom: 1px solid rgba(222, 226, 230, 0.5); /* å¢åŠ åº•éƒ¨è¾¹æ¡† */
      display: none; /* é»˜è®¤éšè— */
      /* å¢åŠ èƒŒæ™¯è‰²ï¼Œæå‡å¯è¯»æ€§ */
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
    }

    .stock-name-display.show {
      display: block;
    }

    .stock-name-display .label {
      font-weight: 600;
      color: #2c3e50;
      margin-right: 10px;
    }

    .stock-name-display .value {
      font-weight: 500;
      color: #3498db;
      font-size: 16px;
    }

    /* ========== å“åº”å¼é€‚é…è°ƒæ•´ ========== */
    @media (max-width: 768px) {
      html {
        padding-top: 70px; /* ç§»åŠ¨ç«¯è°ƒæ•´é¡¶éƒ¨é¢„ç•™ç©ºé—´ */
      }
      .chart-area {
        height: 400px;
        padding: 15px;
      }
      .config-item {
        flex-direction: column;
        align-items: flex-start;
        white-space: normal; /* ç§»åŠ¨ç«¯æ¢å¤æ­£å¸¸æ¢è¡Œ */
      }
      .config-item label {
        width: 100%;
        text-align: left;
        margin-bottom: 10px;
      }
      .config-item input,
      .stock-info-item input,
      .autocomplete input {
        width: 100%;
        min-width: unset; /* ç§»åŠ¨ç«¯å–æ¶ˆæœ€å°å®½åº¦ */
        height: auto; /* ç§»åŠ¨ç«¯æ¢å¤è‡ªåŠ¨é«˜åº¦ */
      }
      .autocomplete {
        width: 100%;
        min-width: unset; /* ç§»åŠ¨ç«¯å–æ¶ˆæœ€å°å®½åº¦ */
      }
      h1 {
        font-size: 2rem;
      }
      /* ç§»åŠ¨ç«¯Logoé€‚é… */
      .logo-img {
        width: 30px !important;
        height: 30px !important;
      }
      h3 {
        font-size: 1.3rem;
      }
      .main-config-area {
        padding: 20px 15px;
      }
      /* ç§»åŠ¨ç«¯ç”°å­—æ ¼æ”¹ä¸ºå•åˆ— */
      .result-grid {
        grid-template-columns: 1fr;
      }
      /* ç§»åŠ¨ç«¯ç­–ç•¥å‚æ•°å˜å›ä¸Šä¸‹æ’åˆ— */
      .strategy-flex-container {
        flex-direction: column;
        gap: 20px;
      }
      .strategy-valuation-container {
        flex: 1;
        width: 100%;
        min-width: unset; /* ç§»åŠ¨ç«¯å–æ¶ˆæœ€å°å®½åº¦ */
        margin-left: 0; /* ç§»åŠ¨ç«¯å–æ¶ˆä¸­çº¿å¯¹é½ */
        transform: none; /* ç§»åŠ¨ç«¯å–æ¶ˆä½ç§» */
      }
      .strategy-basic-container {
        padding-right: 0; /* ç§»åŠ¨ç«¯å–æ¶ˆå³ä¾§é—´è· */
      }
      /* ç§»åŠ¨ç«¯è‚¡ç¥¨ä¿¡æ¯é¡¹å †å  */
      .stock-info-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      .stock-info-item {
        width: 100%;
        min-width: unset; /* ç§»åŠ¨ç«¯å–æ¶ˆæœ€å°å®½åº¦ */
      }
      /* ç§»åŠ¨ç«¯å†»ç»“çª—æ ¼æ ·å¼ä¼˜åŒ– */
      .stock-name-display {
        padding: 10px 15px;
        font-size: 14px;
      }
      .stock-name-display .value {
        font-size: 14px;
      }
    }

    /* å…¥åœºåŠ¨ç”» */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .container > div {
      animation: fadeInUp 0.5s ease forwards;
    }

    .container > div:nth-child(1) { animation-delay: 0.1s; }
    .container > div:nth-child(2) { animation-delay: 0.2s; }
    .container > div:nth-child(3) { animation-delay: 0.3s; }
    .container > div:nth-child(4) { animation-delay: 0.4s; }
    .container > div:nth-child(5) { animation-delay: 0.5s; }
    
    /* ========== æ–°å¢ï¼šç»Ÿä¸€å³ä¾§æ ‡é¢˜æ ·å¼ï¼Œç¡®ä¿å¯¹é½ ========== */
    .strategy-valuation-container h4 {
      margin: 0 0 20px 0; /* ç§»é™¤é¡¶éƒ¨marginï¼Œç¡®ä¿ç¬¬ä¸€ä¸ªé…ç½®é¡¹å’Œå·¦ä¾§å¯¹é½ */
      padding-left: 10px;
      position: relative;
    }
    
    .strategy-valuation-container h4::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 24px;
      background: linear-gradient(180deg, #3498db, #9b59b6);
      margin-right: 10px;
      border-radius: 3px;
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
    }
  </style>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- ç™»å½•å¼¹çª—ï¼ˆæ°¸ä¹…éšè—ï¼Œä¸å†ä½¿ç”¨ï¼‰ -->
  <div class="login-modal hidden" id="loginModal">
    <div class="login-box">
      <h2>ç”¨æˆ·ç™»å½•</h2>
      <input type="text" class="login-input" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
      <input type="password" class="login-input" id="password" placeholder="è¯·è¾“å…¥å¯†ç " />
      <div class="login-error" id="loginError"></div>
      <button class="btn login-btn" id="doLoginBtn">ç™»å½•</button>
    </div>
  </div>

  <!-- è‚¡ç¥¨åç§°æ˜¾ç¤ºåŒºåŸŸï¼ˆç§»åˆ°bodyæœ€å¤–å±‚ï¼Œç¡®ä¿å…¨å±å›ºå®šï¼‰ -->
  <div class="stock-name-display" id="stockNameDisplay">
    <span class="label">å½“å‰åˆ†æè‚¡ç¥¨ï¼š</span>
    <span class="value" id="stockNameValue">è´µå·èŒ…å° (sh.600519)</span>
  </div>

  <div class="container">
    <!-- ç™»å½•çŠ¶æ€æç¤ºï¼ˆçº¯æ¸¸å®¢æ¨¡å¼ï¼Œæ— ç™»å½•æŒ‰é’®ï¼‰ -->
    <div class="login-status" id="loginStatus">
      æ¸¸å®¢æ¨¡å¼ï¼ˆæ‰€æœ‰åŠŸèƒ½å¯ç”¨ï¼‰
    </div>

    <!-- æ ‡é¢˜æ·»åŠ Logo -->
    <h1>
      <img src="static/logo/stock_logo.png" alt="è‚¡ç¥¨å®šæŠ•åˆ†ælogo" class="logo-img">
      è”ææŠ•ç ”-è‚¡ç¥¨å®šæŠ•åŠ©æ‰‹
    </h1>

    <!-- åˆå¹¶åçš„é…ç½®ä¸»å®¹å™¨ -->
    <div class="main-config-area">
      <!-- æ•°æ®æºé…ç½®åˆ†åŒº -->
      <div class="config-section">
        <h3>è‚¡ç¥¨é€‰æ‹©</h3>
        <div class="data-source-content active" id="baostock-tab">
          <!-- ========== ä¼˜åŒ–ï¼šè‚¡ç¥¨ä¿¡æ¯æ¨ªå‘æ’åˆ—æ ·å¼ ========== -->
          <div class="stock-info-row">
            <div class="stock-info-item">
              <label>è‚¡ç¥¨ä»£ç ï¼š</label>
              <div class="autocomplete">
                <input type="text" id="stockInput" value="è´µå·èŒ…å°" placeholder="è¾“å…¥åç§°å¦‚'è´µå·èŒ…å°'æˆ–ä»£ç 'sh.600519'">
                <div id="autocomplete-list" class="autocomplete-items"></div>
              </div>
            </div>
            <div class="stock-info-item">
              <label>å¼€å§‹æ—¶é—´ï¼š</label>
              <input type="date" id="baostockStartDate" value="2019-07-01">
            </div>
            <div class="stock-info-item">
              <label>ç»“æŸæ—¶é—´ï¼š</label>
              <input type="date" id="baostockEndDate" value="2020-07-01">
            </div>
          </div>

          <!-- ç§»é™¤åŸæ¥çš„è‚¡ç¥¨åç§°æ˜¾ç¤ºåŒºåŸŸï¼Œç§»åˆ°bodyå¤–å±‚ -->
        </div>
      </div>

      <!-- åŸºç¡€ç­–ç•¥å‚æ•°é…ç½®åˆ†åŒºï¼ˆFlexå¹¶æ’ï¼‰ -->
      <div class="config-section">
        <h3>å®šæŠ•åŸºç¡€ç­–ç•¥å‚æ•°</h3>
        <!-- ========== ä¼˜åŒ–ï¼šè°ƒæ•´Flexé—´è·å’Œå®½åº¦ ========== -->
        <div class="strategy-flex-container">
          <!-- åŸºç¡€ç­–ç•¥å‚æ•°å®¹å™¨ï¼ˆå·¦ä¾§ï¼‰ -->
          <div class="strategy-basic-container">
            <div class="config-item">
              <label>åˆå§‹æœ¬é‡‘ï¼ˆå…ƒï¼‰ï¼š</label>
              <input type="number" id="initialCapital" value="100000" min="1000" />
            </div>
            <div class="config-item">
              <label>å¼€å§‹æ—¶é—´ï¼š</label>
              <input type="date" id="startDate" value="2019-07-15" />
            </div>
            <div class="config-item">
              <label>åœæ­¢æ—¶é—´ï¼š</label>
              <input type="date" id="endDate" value="2020-07-15" />
            </div>
            <div class="config-item">
              <label>å®šæŠ•é‡‘é¢ï¼ˆå…ƒ/å‘¨ï¼‰ï¼š</label>
              <input type="number" id="investAmount" value="1000" min="100" />
            </div>
            <div class="config-item">
              <label>åº•ä»“æ¯”ä¾‹ï¼ˆ%ï¼‰ï¼š</label>
              <input type="number" id="baseRatio" value="50" min="0" max="100" />
            </div>
            <div class="config-item">
              <label>æ‰‹ç»­è´¹ç‡ï¼ˆ%ï¼‰ï¼š</label>
              <input type="number" id="feeRate" value="0.1" step="0.01" min="0" max="1" />
            </div>
          </div>

          <!-- åŠ¨æ€ä¼°å€¼æ­¢ç›ˆå‚æ•°å®¹å™¨ï¼ˆå³ä¾§ï¼‰- ä¿®æ”¹åæ ·å¼ -->
          <div class="strategy-valuation-container">
            <h4>åŠ¨æ€ä¼°å€¼æ­¢ç›ˆç­–ç•¥å‚æ•°</h4>
            <div class="config-item">
              <label>PEåˆ†ä½ç‚¹ä¸‹é™ï¼ˆ%ï¼‰ï¼š</label>
              <input type="number" id="peLowerQuantile" value="30" min="0" max="100" />
            </div>
            <div class="config-item">
              <label>PEåˆ†ä½ç‚¹ä¸Šé™ï¼ˆ%ï¼‰ï¼š</label>
              <input type="number" id="peUpperQuantile" value="70" min="0" max="100" />
            </div>
          </div>
        </div>

        <!-- åŠ è½½æŒ‰é’®ç§»åˆ°ç­–ç•¥å‚æ•°é…ç½®æœ€ä¸‹æ–¹ -->
        <button class="btn" id="loadBaostockDataBtn">å¼€å§‹åˆ†æ</button>
      </div>
    </div>

    <!-- æ—¥å¿—åŒºåŸŸ - éšè—ï¼ˆä¸å†å‰ç«¯æ˜¾ç¤ºï¼‰ -->
    <div class="log-area" id="logArea">
      å¼€å§‹åˆ†æ...
    </div>

    <!-- ç»“æœæ±‡æ€» - ç”°å­—æ ¼å¸ƒå±€ -->
    <div class="result-summary hidden" id="resultSummary">
      <h4>ğŸ“Š ç­–ç•¥åˆ†ææœ€ç»ˆç»“æœ</h4>
      <div class="result-grid" id="resultContent"></div>
    </div>

    <h3>å›¾è¡¨1ï¼šè‚¡ä»· vs PEåˆ†ä½ç‚¹ vs æ¯è‚¡ç›ˆåˆ©TTM</h3>
    <div class="chart-area" id="chartPricePE" class="hidden"></div>

    <h3>å›¾è¡¨2ï¼šæ€»æ”¶ç›Šç‡ï¼ˆå«ä¹°å–ç‚¹æ ‡æ³¨ï¼‰</h3>
    <div class="chart-area" id="chartReturn" class="hidden"></div>

    <h3>å›¾è¡¨3ï¼šç´¯è®¡æŠ•å…¥é‡‘é¢ vs ç´¯è®¡æ”¶ç›Š</h3>
    <div class="chart-area" id="chartInvestProfit" class="hidden"></div>

    <h3>å›¾è¡¨4ï¼šPEå€¼èµ°åŠ¿ï¼ˆå«å‡å€¼å‚è€ƒï¼‰</h3>
    <div class="chart-area" id="chartPE" class="hidden"></div>

    <!-- ========== è°ƒæ•´ï¼šç­–ç•¥è¯´æ˜ç§»åˆ°ç½‘é¡µæœ€ä¸‹æ–¹ ========== -->
    <div class="strategy-tip">
      âœ… ç­–ç•¥è¯´æ˜ï¼šå…¨ç¨‹ä½¿ç”¨è‡ªæœ‰èµ„é‡‘ï¼Œæ— èèµ„/æ æ†/å€Ÿæ¬¾ç­‰æ“ä½œ
    </div>

  <script>
    // å…¨å±€å˜é‡
    let stockNames = [];
    let isDataLoaded = false;
    // æ–°å¢ï¼šå­˜å‚¨å½“å‰è‚¡ç¥¨åç§°å’Œä»£ç 
    let currentStockName = "";
    let currentStockCode = "";

    // å·¥å…·å‡½æ•°ï¼šæ—¥å¿—ä»…è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆä¸åœ¨å‰ç«¯æ˜¾ç¤ºï¼‰
    function log(msg) {
      console.log(`${new Date().toLocaleString()} | ${msg}`); // ä»…æ§åˆ¶å°è¾“å‡º
    }

    // æ–°å¢ï¼šè·å–å½“å‰æ—¥æœŸï¼ˆæ ¼å¼YYYY-MM-DDï¼‰
    function getCurrentDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // æ–°å¢ï¼šæ ‡å‡†åŒ–è‚¡ç¥¨ä»£ç ï¼ˆå¦‚600000 â†’ sh.600000ï¼Œ000001 â†’ sz.000001ï¼‰
    function normalizeStockCode(code) {
      if (!code) return "";
      // å¦‚æœå·²ç»æ˜¯æ ‡å‡†åŒ–ä»£ç ï¼ˆå«sh./sz.ï¼‰ï¼Œç›´æ¥è¿”å›
      if (code.startsWith("sh.") || code.startsWith("sz.")) return code;
      // æ²ªå¸‚Aè‚¡ï¼š60å¼€å¤´
      if (/^60\d{4}$/.test(code)) return `sh.${code}`;
      // æ·±å¸‚Aè‚¡ï¼š00å¼€å¤´ï¼ˆä¸»æ¿ï¼‰ã€30å¼€å¤´ï¼ˆåˆ›ä¸šæ¿ï¼‰
      if (/^(00|30)\d{4}$/.test(code)) return `sz.${code}`;
      // åŒ—äº¤æ‰€ï¼š8å¼€å¤´
      if (/^8\d{4}$/.test(code)) return `bj.${code}`;
      // æ— æ³•æ ‡å‡†åŒ–çš„è¿”å›åŸä»£ç 
      return code;
    }

    // æ–°å¢ï¼šæ›´æ–°è‚¡ç¥¨åç§°æ˜¾ç¤ºåŒºåŸŸ
    function updateStockNameDisplay(name, code) {
      const displayEl = document.getElementById("stockNameDisplay");
      const valueEl = document.getElementById("stockNameValue");
      
      if (name && code) {
        currentStockName = name;
        // æ ‡å‡†åŒ–ä»£ç åå†å­˜å‚¨
        currentStockCode = normalizeStockCode(code);
        valueEl.textContent = `${name} (${currentStockCode})`;
        displayEl.classList.add("show");
        // åŒæ­¥æ›´æ–°è¾“å…¥æ¡†çš„å€¼ï¼ˆç¡®ä¿ä¸€è‡´æ€§ï¼‰
        document.getElementById("stockInput").value = name;
      } else {
        displayEl.classList.remove("show");
      }
    }

    // ç§»é™¤ç™»å½•çŠ¶æ€æ£€æŸ¥å‡½æ•°ï¼Œç›´æ¥ç®€åŒ–ä¸ºæ¸¸å®¢æ¨¡å¼
    function checkLoginStatus() {
      // å›ºå®šæ˜¾ç¤ºæ¸¸å®¢æ¨¡å¼ï¼Œæ— ç™»å½•æŒ‰é’®
      document.getElementById("loginStatus").innerHTML = `
        æ¸¸å®¢æ¨¡å¼ï¼ˆæ‰€æœ‰åŠŸèƒ½å¯ç”¨ï¼‰
      `;
      // åˆå§‹åŒ–æ˜¾ç¤ºé»˜è®¤è‚¡ç¥¨åç§°
      updateStockNameDisplay("è´µå·èŒ…å°", "sh.600519");
      // ç›´æ¥åŠ è½½è‚¡ç¥¨åç§°åˆ—è¡¨ï¼ˆæ— éœ€ç™»å½•ï¼‰
      loadStockNames();
    }

    // åŠ è½½è‚¡ç¥¨åç§°åˆ—è¡¨ï¼ˆæ— éœ€ç™»å½•ï¼Œç§»é™¤tokenç›¸å…³é€»è¾‘ï¼‰
    async function loadStockNames() {
      try {
        // ä»…ä½¿ç”¨åŸºç¡€è¯·æ±‚å¤´ï¼Œä¸æºå¸¦token
        const headers = { "Content-Type": "application/json" };
        
        const response = await fetch("api/stock_names", {
          headers: headers
        });
        const result = await response.json();
        if (result.code === 200) {
          stockNames = result.data;
          autocomplete(document.getElementById("stockInput"), stockNames);
          log(`âœ… åŠ è½½è‚¡ç¥¨åç§°åˆ—è¡¨æˆåŠŸï¼Œå…±${stockNames.length}æ¡`);
        }
      } catch (e) {
        log(`âš ï¸ åŠ è½½è‚¡ç¥¨åç§°åˆ—è¡¨å¤±è´¥ï¼š${e.message}ï¼ˆå¯æ‰‹åŠ¨è¾“å…¥è‚¡ç¥¨ä»£ç /åç§°ï¼‰`);
        // å¤±è´¥åä¸å¤„ç†ï¼Œç”¨æˆ·å¯æ‰‹åŠ¨è¾“å…¥
      }
    }

    // è‚¡ç¥¨åç§°è‡ªåŠ¨è¡¥å…¨ï¼ˆå¤±è´¥ä¸å½±å“æ‰‹åŠ¨è¾“å…¥ï¼‰
    function autocomplete(inp, arr) {
      // å¦‚æœæ— æ•°æ®ï¼Œç›´æ¥è¿”å›ï¼ˆç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ï¼‰
      if (!arr || arr.length === 0) return;
      
      let currentFocus;
      inp.addEventListener("input", function(e) {
        let a, b, i, val = this.value;
        closeAllLists();
        if (!val) return false;
        currentFocus = -1;
        a = document.createElement("DIV");
        a.setAttribute("id", this.id + "autocomplete-list");
        a.setAttribute("class", "autocomplete-items");
        this.parentNode.appendChild(a);
        
        for (i = 0; i < arr.length; i++) {
          if (arr[i].toLowerCase().indexOf(val.toLowerCase()) > -1) {
            b = document.createElement("DIV");
            b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
            b.innerHTML += arr[i].substr(val.length);
            b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
            b.addEventListener("click", function(e) {
              inp.value = this.getElementsByTagName("input")[0].value;
              // ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨åï¼Œä¸»åŠ¨æŸ¥è¯¢è‚¡ç¥¨ä»£ç å¹¶æ›´æ–°æ˜¾ç¤º
              getStockInfoByInput(inp.value);
              closeAllLists();
            });
            a.appendChild(b);
          }
        }
      });

      inp.addEventListener("keydown", function(e) {
        let x = document.getElementById(this.id + "autocomplete-list");
        if (x) x = x.getElementsByTagName("div");
        if (e.keyCode == 40) {
          currentFocus++;
          addActive(x);
        } else if (e.keyCode == 38) {
          currentFocus--;
          addActive(x);
        } else if (e.keyCode == 13) {
          e.preventDefault();
          if (currentFocus > -1 && x) {
            x[currentFocus].click();
          } else {
            // å›è½¦æ—¶ä¸»åŠ¨æŸ¥è¯¢è‚¡ç¥¨ä¿¡æ¯
            getStockInfoByInput(inp.value);
          }
        }
      });

      function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        x[currentFocus].classList.add("autocomplete-active");
      }

      function removeActive(x) {
        for (let i = 0; i < x.length; i++) {
          x[i].classList.remove("autocomplete-active");
        }
      }

      function closeAllLists(elmnt) {
        let x = document.getElementsByClassName("autocomplete-items");
        for (let i = 0; i < x.length; i++) {
          if (elmnt != x[i] && elmnt != inp) {
            x[i].parentNode.removeChild(x[i]);
          }
        }
      }

      document.addEventListener("click", function (e) {
        closeAllLists(e.target);
      });
    }

    // æ–°å¢ï¼šæ ¹æ®è¾“å…¥å†…å®¹æŸ¥è¯¢è‚¡ç¥¨è¯¦ç»†ä¿¡æ¯ï¼ˆè°ƒç”¨åç«¯/api/stock_infoæ¥å£ï¼‰
    async function getStockInfoByInput(inputStr) {
      if (!inputStr) return;
      
      try {
        const headers = { "Content-Type": "application/json" };
        // å…ˆæ ‡å‡†åŒ–è¾“å…¥çš„ä»£ç ï¼Œå†è¯·æ±‚
        const normalizedInput = normalizeStockCode(inputStr);
        const response = await fetch(`api/stock_info?input=${encodeURIComponent(normalizedInput)}`, {
          headers: headers
        });
        
        if (!response.ok) throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š${response.status}`);
        const result = await response.json();
        
        if (result.code === 200 && result.data.name && result.data.code) {
          updateStockNameDisplay(result.data.name, result.data.code);
          log(`âœ… è‚¡ç¥¨ä¿¡æ¯æŸ¥è¯¢æˆåŠŸï¼š${result.data.name} (${result.data.code})`);
        } else {
          // å¦‚æœåç«¯æ²¡è¿”å›ï¼Œå°è¯•ç”¨è¾“å…¥çš„æ ‡å‡†åŒ–ä»£ç ä½œä¸ºå…œåº•
          updateStockNameDisplay(inputStr, normalizedInput);
          log(`âš ï¸ æœªæŸ¥è¯¢åˆ°è‚¡ç¥¨è¯¦ç»†ä¿¡æ¯ï¼Œä½¿ç”¨æ ‡å‡†åŒ–ä»£ç ï¼š${normalizedInput}`);
        }
      } catch (e) {
        // å¼‚å¸¸æ—¶ä¹Ÿæ ‡å‡†åŒ–ä»£ç å¹¶æ˜¾ç¤º
        const normalizedInput = normalizeStockCode(inputStr);
        updateStockNameDisplay(inputStr, normalizedInput);
        log(`âŒ æŸ¥è¯¢è‚¡ç¥¨ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨æ ‡å‡†åŒ–ä»£ç å…œåº•ï¼š${normalizedInput} | é”™è¯¯ï¼š${e.message}`);
      }
    }

    // åŠ è½½Baostockæ•°æ® + è‡ªåŠ¨åˆ†æï¼ˆå®Œå…¨è„±ç¦»ç™»å½•ä¾èµ–ï¼‰
    document.getElementById("loadBaostockDataBtn").addEventListener("click", async function() {
      const btn = this;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>éªŒè¯å¹¶åˆ†æä¸­...';
      log("å¼€å§‹éªŒè¯Baostockæ•°æ®å¯ç”¨æ€§å¹¶å‡†å¤‡è‡ªåŠ¨åˆ†æ...");
      
      try {
        const stockInput = document.getElementById("stockInput").value.trim();
        const startDate = document.getElementById("baostockStartDate").value;
        // å¼ºåˆ¶ä½¿ç”¨å½“å‰æ—¥æœŸä½œä¸ºç»“æŸæ—¥æœŸ
        const endDate = getCurrentDate();
        
        // å‰ç½®æ ¡éªŒ1ï¼šå¿…é¡»è¾“å…¥è‚¡ç¥¨ä¿¡æ¯
        if (!stockInput) {
          throw new Error("è¯·è¾“å…¥è‚¡ç¥¨åç§°/ä»£ç ");
        }
        // å‰ç½®æ ¡éªŒ2ï¼šå¿…é¡»é€‰æ‹©å¼€å§‹æ—¥æœŸ
        if (!startDate) {
          throw new Error("è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ");
        }
        // å‰ç½®æ ¡éªŒ3ï¼šç¡®ä¿æœ‰æ ‡å‡†åŒ–çš„è‚¡ç¥¨ä»£ç 
        if (!currentStockCode) {
          // ä¸»åŠ¨æŸ¥è¯¢è‚¡ç¥¨ä¿¡æ¯
          await getStockInfoByInput(stockInput);
          // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œç›´æ¥æ ‡å‡†åŒ–è¾“å…¥å€¼
          if (!currentStockCode) {
            currentStockCode = normalizeStockCode(stockInput);
          }
        }
        // å‰ç½®æ ¡éªŒ4ï¼šæ ‡å‡†åŒ–ä»£ç ä¸èƒ½ä¸ºç©º
        if (!currentStockCode) {
          throw new Error("æ— æ³•è¯†åˆ«çš„è‚¡ç¥¨ä»£ç ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ ¼å¼ï¼ˆå¦‚sh.600519ã€600000ï¼‰");
        }
        
        log(`ğŸ“Œ æœ€ç»ˆä½¿ç”¨çš„è‚¡ç¥¨ä»£ç ï¼š${currentStockCode} | åç§°ï¼š${currentStockName || stockInput}`);
        log(`ğŸ“… åˆ†ææ—¶é—´èŒƒå›´ï¼š${startDate} è‡³ ${endDate}ï¼ˆå½“å‰æœ€æ–°æ—¥æœŸï¼‰`);
        
        // 1. éªŒè¯æ•°æ®æ˜¯å¦å­˜åœ¨ï¼ˆæ— tokenï¼Œçº¯æ¸¸å®¢è¯·æ±‚ï¼‰
        const headers = { "Content-Type": "application/json" };
        
        // å…³é”®ä¿®å¤ï¼šä¼ é€’æ ‡å‡†åŒ–çš„currentStockCodeï¼Œè€Œéè¾“å…¥æ¡†åŸå§‹å€¼
        const response = await fetch(`api/stock_data?code=${encodeURIComponent(currentStockCode)}&start_date=${startDate}&end_date=${endDate}`, {
          headers: headers
        });
        
        if (!response.ok) throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š${response.status}ï¼ˆè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œï¼‰`);
        const result = await response.json();
        
        if (result.code !== 200 || !result.data || result.data.length === 0) {
          throw new Error("è·å–æ•°æ®å¤±è´¥ï¼š" + (result.msg || "æ— æ•°æ®ï¼ˆè¯·ç¡®è®¤è‚¡ç¥¨ä»£ç å’Œæ—¥æœŸèŒƒå›´æœ‰æ•ˆï¼‰"));
        }
        
        // æ ¸å¿ƒä¼˜åŒ–ï¼šä¼˜å…ˆä»åç«¯è¿”å›ç»“æœæå–è‚¡ç¥¨åç§°å’Œä»£ç 
        let stockName = result.stock_name || currentStockName || stockInput;
        let stockCode = result.stock_code || currentStockCode;
        
        // æ›´æ–°è‚¡ç¥¨åç§°æ˜¾ç¤º
        updateStockNameDisplay(stockName, stockCode);
        
        log(`âœ… Baostockæ•°æ®éªŒè¯æˆåŠŸï¼å…±${result.data.length}æ¡æœ‰æ•ˆè®°å½• | è‚¡ç¥¨ï¼š${stockName} (${stockCode})`);
        document.getElementById("startDate").value = startDate;
        document.getElementById("endDate").value = endDate;
        isDataLoaded = true;

        // 2. æ•°æ®éªŒè¯æˆåŠŸåï¼Œè‡ªåŠ¨è§¦å‘åˆ†æ
        await analyzeStrategy();

      } catch (error) {
        log(`âŒ æ“ä½œå¤±è´¥ï¼š${error.message}`);
        isDataLoaded = false;
        alert(`æ“ä½œå¤±è´¥ï¼š${error.message}`); // å‰ç«¯å‹å¥½æç¤º
      } finally {
        btn.disabled = false;
        btn.innerHTML = "å¼€å§‹åˆ†æ";
      }
    });

    // ç­–ç•¥åˆ†ææ ¸å¿ƒå‡½æ•°ï¼ˆå®Œå…¨è„±ç¦»ç™»å½•ä¾èµ–ï¼‰
    async function analyzeStrategy() {
      log("ğŸš€ å¼€å§‹è‡ªåŠ¨æ‰§è¡Œç­–ç•¥åˆ†æ...");

      // éšè—æ‰€æœ‰å›¾è¡¨å’Œç»“æœ
      document.getElementById("resultSummary").classList.add("hidden");
      document.getElementById("chartPricePE").classList.add("hidden");
      document.getElementById("chartReturn").classList.add("hidden");
      document.getElementById("chartInvestProfit").classList.add("hidden");
      document.getElementById("chartPE").classList.add("hidden");

      try {
        // æ”¶é›†æ‰€æœ‰å‚æ•°
        const params = {
          stockCode: currentStockCode, // å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ ‡å‡†åŒ–çš„ä»£ç 
          stockName: currentStockName || document.getElementById("stockInput").value.trim(),
          baostockStartDate: document.getElementById("baostockStartDate").value,
          baostockEndDate: getCurrentDate(), // å¼ºåˆ¶ä½¿ç”¨å½“å‰æ—¥æœŸ
          initialCapital: document.getElementById("initialCapital").value,
          startDate: document.getElementById("startDate").value,
          endDate: document.getElementById("endDate").value,
          investAmount: document.getElementById("investAmount").value,
          baseRatio: document.getElementById("baseRatio").value,
          feeRate: document.getElementById("feeRate").value,
          peLowerQuantile: document.getElementById("peLowerQuantile").value,
          peUpperQuantile: document.getElementById("peUpperQuantile").value
        };

        // å‘é€POSTè¯·æ±‚åˆ°åç«¯åˆ†ææ¥å£ï¼ˆæ— tokenï¼Œçº¯æ¸¸å®¢è¯·æ±‚ï¼‰
        const headers = { "Content-Type": "application/json" };
        
        const response = await fetch("api/analyze_strategy", {
          method: "POST",
          headers: headers,
          body: JSON.stringify(params)
        });

        if (!response.ok) throw new Error(`åç«¯è¯·æ±‚å¤±è´¥ï¼š${response.status}ï¼ˆè¯·æ£€æŸ¥åˆ†ææ¥å£æ˜¯å¦æ­£å¸¸ï¼‰`);
        const result = await response.json();

        // æ˜¾ç¤ºæ—¥å¿—ï¼ˆä»…æ§åˆ¶å°ï¼‰
        if (result.logs && result.logs.length > 0) {
          result.logs.forEach(msg => log(msg));
        }

        // å¤„ç†åˆ†æç»“æœä¸­çš„è‚¡ç¥¨åç§°æ›´æ–°
        if (result.stock_name && result.stock_code) {
          updateStockNameDisplay(result.stock_name, result.stock_code);
          log(`âœ… ç­–ç•¥åˆ†æè¿”å›è‚¡ç¥¨ä¿¡æ¯ï¼š${result.stock_name} (${result.stock_code})`);
        }

        // å¤„ç†åˆ†æç»“æœ
        if (result.success) {
          // æ˜¾ç¤ºç»“æœæ±‡æ€»ï¼ˆç”°å­—æ ¼ï¼‰
          showResultSummary(result.result_summary);
          
          // æ¸²æŸ“å›¾è¡¨
          renderChart("chartPricePE", result.chart_data.chart1);
          renderChart("chartReturn", result.chart_data.chart2);
          renderChart("chartInvestProfit", result.chart_data.chart3);
          renderChart("chartPE", result.chart_data.chart4);
          
          log("\nğŸ‰ è‡ªåŠ¨åˆ†æå®Œæˆï¼æ‰€æœ‰å›¾è¡¨å·²æ¸²æŸ“");
        } else {
          log(`âŒ åˆ†æå¤±è´¥ï¼š${result.error || "æœªçŸ¥é”™è¯¯"}`);
          alert(`åˆ†æå¤±è´¥ï¼š${result.error || "æœªçŸ¥é”™è¯¯"}`);
        }

      } catch (error) {
        log(`âŒ åˆ†æè¯·æ±‚å¼‚å¸¸ï¼š${error.message}`);
        console.error(error);
        alert(`åˆ†æè¯·æ±‚å¼‚å¸¸ï¼š${error.message}\nè¯·æ£€æŸ¥ï¼š1.åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ 2.è‚¡ç¥¨ä»£ç æ˜¯å¦æœ‰æ•ˆ 3.æ—¥æœŸèŒƒå›´æ˜¯å¦åˆç†`);
      }
    }

    // æ˜¾ç¤ºç»“æœæ±‡æ€»ï¼ˆç”°å­—æ ¼å¸ƒå±€ï¼‰
    function showResultSummary(summary) {
      const resultContent = document.getElementById("resultContent");
      let html = "";
      
      for (const [strategy, data] of Object.entries(summary)) {
        html += `<div class="result-card">`;
        html += `<div class="strategy-name">${strategy}</div>`;
        html += `<div class="result-metric">`;
        html += `<span>æ”¶ç›Šç‡</span>`;
        html += `<span class="value">${data.æ”¶ç›Šç‡}</span>`;
        html += `</div>`;
        html += `<div class="result-metric">`;
        html += `<span>æ”¶ç›Šé‡‘é¢</span>`;
        html += `<span class="value">${data.æ”¶ç›Šé‡‘é¢}</span>`;
        html += `</div>`;
        if (data.æœ€ç»ˆä»“ä½) {
          html += `<div class="result-metric">`;
          html += `<span>æœ€ç»ˆä»“ä½</span>`;
          html += `<span class="value">${data.æœ€ç»ˆä»“ä½}</span>`;
          html += `</div>`;
        }
        html += `</div>`;
      }
      
      resultContent.innerHTML = html;
      document.getElementById("resultSummary").classList.remove("hidden");
    }

    // æ¸²æŸ“å›¾è¡¨ï¼ˆç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„Plotlyæ•°æ®ï¼‰
    function renderChart(chartId, chartData) {
      const chartArea = document.getElementById(chartId);
      chartArea.classList.remove("hidden");
      
      // è½¬æ¢æ—¥æœŸæ ¼å¼ä¸ºPlotlyå¯è¯†åˆ«çš„æ ¼å¼
      chartData.traces.forEach(trace => {
        if (trace.x && trace.x.length > 0 && typeof trace.x[0] === "string") {
          trace.x = trace.x.map(dateStr => new Date(dateStr));
        }
      });
      
      // æ¸²æŸ“å›¾è¡¨
      Plotly.newPlot(chartArea, chartData.traces, chartData.layout, { 
        responsive: true,
        displayModeBar: true
      });
    }

    // é¡µé¢åˆå§‹åŒ–
    window.onload = function() {
      // åˆå§‹åŒ–æ¸¸å®¢æ¨¡å¼
      checkLoginStatus();
      
      // æ ¸å¿ƒä¿®æ”¹1ï¼šè®¾ç½®ç»“æŸæ—¥æœŸä¸ºå½“å‰æœ€æ–°æ—¥æœŸ
      const currentDate = getCurrentDate();
      document.getElementById("baostockEndDate").value = currentDate;
      document.getElementById("endDate").value = currentDate;
      log(`ğŸ“… é¡µé¢åˆå§‹åŒ–ï¼Œç»“æŸæ—¥æœŸå·²è‡ªåŠ¨è®¾ä¸ºå½“å‰æ—¥æœŸï¼š${currentDate}`);
      
      // ä¸ºè‚¡ç¥¨è¾“å…¥æ¡†æ·»åŠ å¤±å»ç„¦ç‚¹äº‹ä»¶ï¼Œè‡ªåŠ¨æŸ¥è¯¢è‚¡ç¥¨ä¿¡æ¯
      document.getElementById("stockInput").addEventListener("blur", function() {
        const inputVal = this.value.trim();
        if (inputVal && inputVal !== currentStockName) {
          getStockInfoByInput(inputVal);
        }
      });
      
      // ä¸ºè‚¡ç¥¨è¾“å…¥æ¡†æ·»åŠ å›è½¦äº‹ä»¶
      document.getElementById("stockInput").addEventListener("keyup", function(e) {
        if (e.key === "Enter") {
          const inputVal = this.value.trim();
          if (inputVal) {
            getStockInfoByInput(inputVal);
          }
        }
      });
      
      log("âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼ˆçº¯æ¸¸å®¢æ¨¡å¼ï¼Œæ‰€æœ‰åŠŸèƒ½å¯ç”¨ï¼‰");
    };
  </script>
<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
</body>
</html>