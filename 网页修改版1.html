<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è‚¡ç¥¨å®šæŠ•ç­–ç•¥åˆ†æï¼ˆå®Œå…¨ç¦»çº¿ç‰ˆï¼‰</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Microsoft YaHei", Arial, sans-serif;
      }
      .container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 20px;
      }
      .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        margin: 20px 0;
        cursor: pointer;
        transition: all 0.3s;
      }
      .upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
      }
      .upload-area input {
        display: none;
      }
      .btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 0;
      }
      .btn:hover {
        background-color: #0056b3;
      }
      .log-area {
        height: 200px;
        border: 1px solid #eee;
        border-radius: 4px;
        padding: 10px;
        margin: 20px 0;
        overflow-y: auto;
        font-size: 14px;
        line-height: 1.5;
      }
      .chart-area {
        margin: 30px 0;
        height: 600px; /* åŸºç¡€é«˜åº¦ï¼Œç»“åˆå“åº”å¼è°ƒæ•´ */
        width: 100%; /* ç¡®ä¿å®½åº¦å æ»¡å®¹å™¨ */
      }
      .config-area {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 8px;
      }
      .config-item {
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .config-item label {
        width: 150px;
        text-align: right;
      }
      .config-item input,
      .config-item select {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 200px;
      }
      .hidden {
        display: none;
      }
      .data-source-area {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 8px;
      }
      .data-source-tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
      }
      .data-source-tab {
        padding: 10px 20px;
        cursor: pointer;
        font-weight: bold;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
      }
      .data-source-tab.active {
        border-bottom-color: #007bff;
        color: #007bff;
      }
      .data-source-content {
        display: none;
      }
      .data-source-content.active {
        display: block;
      }

      /* å“åº”å¼è°ƒæ•´ */
      @media (max-width: 768px) {
        .chart-area {
          height: 400px; /* ç§»åŠ¨ç«¯é™ä½å›¾è¡¨é«˜åº¦ */
        }
        .config-item {
          flex-direction: column;
          align-items: flex-start;
        }
        .config-item label {
          width: 100%;
          text-align: left;
          margin-bottom: 5px;
        }
        .config-item input,
        .config-item select {
          width: 100%;
        }
      }
    </style>

    <!-- å¼•å…¥åœ¨çº¿Plotlyï¼ˆä¿®å¤ç¦»çº¿ç‰ˆåŠ è½½é—®é¢˜ï¼‰ -->
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
    <!-- å¼•å…¥åœ¨çº¿SheetJSï¼ˆä¿®å¤è§£æé—®é¢˜ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>è‚¡ç¥¨å®šæŠ•ç­–ç•¥åˆ†æï¼ˆå®Œå…¨ç¦»çº¿ç‰ˆï¼‰</h1>

      <!-- æ•°æ®æºé€‰æ‹©åŒº -->
      <div class="data-source-area">
        <h3>æ•°æ®æºé€‰æ‹©</h3>
        <div class="data-source-tabs">
          <div class="data-source-tab active" data-tab="internal">å†…ç½®æ•°æ®</div>
          <div class="data-source-tab" data-tab="external">å¤–éƒ¨ä¸Šä¼ </div>
        </div>

        <!-- å†…ç½®æ•°æ®æºå†…å®¹ -->
        <div class="data-source-content active" id="internal-tab">
          <div class="config-item">
            <label>é€‰æ‹©å†…ç½®æ•°æ®ï¼š</label>
            <select id="internalDataSelect">
              <option value="">è¯·é€‰æ‹©...</option>
              <option value="data1">ç¤ºä¾‹æ•°æ®1ï¼šè´µå·èŒ…å°(2019-2020)</option>
              <option value="data2">ç¤ºä¾‹æ•°æ®2ï¼šè…¾è®¯æ§è‚¡(2020-2023)</option>
              <option value="data3">ç¤ºä¾‹æ•°æ®3ï¼šä¸Šè¯æŒ‡æ•°(2020-2023)</option>
            </select>
          </div>
          <button class="btn" id="loadInternalDataBtn" disabled>
            åŠ è½½å†…ç½®æ•°æ®
          </button>
        </div>

        <!-- å¤–éƒ¨æ•°æ®æºå†…å®¹ -->
        <div class="data-source-content" id="external-tab">
          <div class="upload-area" id="uploadArea">
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ ï¼ˆæ”¯æŒExcel/CSVï¼‰</p>
            <p>è¦æ±‚ï¼šæ–‡ä»¶åŒ…å«ã€Œæ—¥æœŸã€å’Œã€Œæ”¶ç›˜ä»·ã€åˆ—</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
          </div>
        </div>
      </div>

      <!-- é…ç½®å‚æ•°åŒº -->
      <div class="config-area">
        <h3>ç­–ç•¥å‚æ•°é…ç½®</h3>
        <div class="config-item">
          <label>åˆå§‹æœ¬é‡‘ï¼ˆå…ƒï¼‰ï¼š</label>
          <input type="number" id="initialCapital" value="100000" min="1000" />
        </div>
        <div class="config-item">
          <label>å¼€å§‹æ—¶é—´ï¼š</label>
          <input type="date" id="startDate" value="2019-07-15" />
        </div>
        <!-- æ–°å¢ï¼šåœæ­¢æ—¶é—´é…ç½®é¡¹ -->
        <div class="config-item">
          <label>åœæ­¢æ—¶é—´ï¼š</label>
          <input type="date" id="endDate" value="2020-07-15" />
        </div>
        <div class="config-item">
          <label>å®šæŠ•é‡‘é¢ï¼ˆå…ƒ/å‘¨ï¼‰ï¼š</label>
          <input type="number" id="investAmount" value="1000" min="100" />
        </div>
        <div class="config-item">
          <label>åº•ä»“æ¯”ä¾‹ï¼ˆ%ï¼‰ï¼š</label>
          <input type="number" id="baseRatio" value="50" min="0" max="100" />
        </div>
        <div class="config-item">
          <label>æ‰‹ç»­è´¹ç‡ï¼ˆ%ï¼‰ï¼š</label>
          <input
            type="number"
            id="feeRate"
            value="0.1"
            step="0.01"
            min="0"
            max="1"
          />
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <button class="btn" id="analyzeBtn" disabled>å¼€å§‹åˆ†æ</button>

      <!-- æ—¥å¿—è¾“å‡ºåŒº -->
      <div class="log-area" id="logArea">
        è¯·é€‰æ‹©æ•°æ®æºå¹¶åŠ è½½æ•°æ®åç‚¹å‡»ã€Œå¼€å§‹åˆ†æã€...
      </div>

      <!-- å›¾è¡¨å±•ç¤ºåŒº - æ‹†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹å›¾è¡¨ -->
      <h3>å›¾è¡¨1ï¼šæ”¶ç›Šç‡å¯¹æ¯”ï¼ˆæ€»æ”¶ç›Šç‡ vs æŒæœ‰æ”¶ç›Šç‡ï¼‰</h3>
      <div class="chart-area" id="chartArea1" class="hidden"></div>

      <h3>å›¾è¡¨2ï¼šé‡‘é¢å¯¹æ¯”ï¼ˆç´¯è®¡æŠ•èµ„ vs ç´¯è®¡æ”¶ç›Šï¼‰</h3>
      <div class="chart-area" id="chartArea2" class="hidden"></div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let rawData = null; // åŸå§‹æ•°æ®
      let resultData = null; // ç­–ç•¥è®¡ç®—ç»“æœ
      let logArea = document.getElementById("logArea");
      let currentDataSource = "internal"; // å½“å‰æ•°æ®æºç±»å‹

      // å†…ç½®æ•°æ®å®šä¹‰
      const internalData = {
        data1: [
          { æ—¥æœŸ: "2019/7/5", æ”¶ç›˜ä»·: 988.2791777 },
          { æ—¥æœŸ: "2019/7/12", æ”¶ç›˜ä»·: 974.7076617 },
          { æ—¥æœŸ: "2019/7/19", æ”¶ç›˜ä»·: 944.8364882 },
          { æ—¥æœŸ: "2019/7/26", æ”¶ç›˜ä»·: 953.8907552 },
          { æ—¥æœŸ: "2019/8/2", æ”¶ç›˜ä»·: 943.4328791 },
          { æ—¥æœŸ: "2019/8/9", æ”¶ç›˜ä»·: 950.9253839 },
          { æ—¥æœŸ: "2019/8/16", æ”¶ç›˜ä»·: 1042.426858 },
          { æ—¥æœŸ: "2019/8/23", æ”¶ç›˜ä»·: 1117.055369 },
          { æ—¥æœŸ: "2019/8/30", æ”¶ç›˜ä»·: 1128.818008 },
          { æ—¥æœŸ: "2019/9/6", æ”¶ç›˜ä»·: 1129.302352 },
          { æ—¥æœŸ: "2019/9/12", æ”¶ç›˜ä»·: 1086.314353 },
          { æ—¥æœŸ: "2019/9/20", æ”¶ç›˜ä»·: 1144.060017 },
          { æ—¥æœŸ: "2019/9/27", æ”¶ç›˜ä»·: 1161.189978 },
          { æ—¥æœŸ: "2019/9/30", æ”¶ç›˜ä»·: 1136.725665 },
          { æ—¥æœŸ: "2019/10/11", æ”¶ç›˜ä»·: 1161.04171 },
          { æ—¥æœŸ: "2019/10/18", æ”¶ç›˜ä»·: 1162.217974 },
          { æ—¥æœŸ: "2019/10/25", æ”¶ç›˜ä»·: 1157.829224 },
          { æ—¥æœŸ: "2019/11/1", æ”¶ç›˜ä»·: 1171.321664 },
          { æ—¥æœŸ: "2019/11/8", æ”¶ç›˜ä»·: 1191.090806 },
          { æ—¥æœŸ: "2019/11/15", æ”¶ç›˜ä»·: 1210.761102 },
          { æ—¥æœŸ: "2019/11/22", æ”¶ç›˜ä»·: 1180.217777 },
          { æ—¥æœŸ: "2019/11/29", æ”¶ç›˜ä»·: 1115.968066 },
          { æ—¥æœŸ: "2019/12/6", æ”¶ç›˜ä»·: 1156.494807 },
          { æ—¥æœŸ: "2019/12/13", æ”¶ç›˜ä»·: 1149.575607 },
          { æ—¥æœŸ: "2019/12/20", æ”¶ç›˜ä»·: 1133.068374 },
          { æ—¥æœŸ: "2019/12/27", æ”¶ç›˜ä»·: 1149.575607 },
          { æ—¥æœŸ: "2020/1/3", æ”¶ç›˜ä»·: 1066.11029 },
          { æ—¥æœŸ: "2020/1/10", æ”¶ç›˜ä»·: 1099.658524 },
          { æ—¥æœŸ: "2020/1/17", æ”¶ç›˜ä»·: 1094.716238 },
          { æ—¥æœŸ: "2020/1/23", æ”¶ç›˜ä»·: 1040.647635 },
          { æ—¥æœŸ: "2020/2/7", æ”¶ç›˜ä»·: 1063.57984 },
          { æ—¥æœŸ: "2020/2/14", æ”¶ç›˜ä»·: 1075.441325 },
          { æ—¥æœŸ: "2020/2/21", æ”¶ç›˜ä»·: 1100.034137 },
          { æ—¥æœŸ: "2020/2/28", æ”¶ç›˜ä»·: 1044.799155 },
          { æ—¥æœŸ: "2020/3/6", æ”¶ç›˜ä»·: 1142.162179 },
          { æ—¥æœŸ: "2020/3/13", æ”¶ç›˜ä»·: 1099.193949 },
          { æ—¥æœŸ: "2020/3/20", æ”¶ç›˜ä»·: 1023.329866 },
          { æ—¥æœŸ: "2020/3/27", æ”¶ç›˜ä»·: 1063.085611 },
          { æ—¥æœŸ: "2020/4/3", æ”¶ç›˜ä»·: 1126.633518 },
          { æ—¥æœŸ: "2020/4/10", æ”¶ç›˜ä»·: 1151.552522 },
          { æ—¥æœŸ: "2020/4/17", æ”¶ç›˜ä»·: 1211.848405 },
          { æ—¥æœŸ: "2020/4/24", æ”¶ç›˜ä»·: 1236.124911 },
          { æ—¥æœŸ: "2020/4/30", æ”¶ç›˜ä»·: 1251.090151 },
          { æ—¥æœŸ: "2020/5/8", æ”¶ç›˜ä»·: 1299.435588 },
          { æ—¥æœŸ: "2020/5/15", æ”¶ç›˜ä»·: 1297.844172 },
          { æ—¥æœŸ: "2020/5/22", æ”¶ç›˜ä»·: 1312.86872 },
          { æ—¥æœŸ: "2020/5/29", æ”¶ç›˜ä»·: 1350.825473 },
          { æ—¥æœŸ: "2020/6/5", æ”¶ç›˜ä»·: 1408.551368 },
          { æ—¥æœŸ: "2020/6/12", æ”¶ç›˜ä»·: 1400.020983 },
          { æ—¥æœŸ: "2020/6/19", æ”¶ç›˜ä»·: 1423.220071 },
          { æ—¥æœŸ: "2020/6/24", æ”¶ç›˜ä»·: 1460.01 },
          { æ—¥æœŸ: "2020/7/3", æ”¶ç›˜ä»·: 1541.79 },
          { æ—¥æœŸ: "2020/7/6", æ”¶ç›˜ä»·: 1600.0 },
        ],
        data2: [
          { æ—¥æœŸ: "2020-01-02", æ”¶ç›˜ä»·: 370.0 },
          { æ—¥æœŸ: "2020-01-03", æ”¶ç›˜ä»·: 365.0 },
          { æ—¥æœŸ: "2020-01-06", æ”¶ç›˜ä»·: 368.0 },
          { æ—¥æœŸ: "2020-01-07", æ”¶ç›˜ä»·: 366.0 },
          { æ—¥æœŸ: "2020-01-08", æ”¶ç›˜ä»·: 370.0 },
          { æ—¥æœŸ: "2023-12-28", æ”¶ç›˜ä»·: 350.0 },
          { æ—¥æœŸ: "2023-12-29", æ”¶ç›˜ä»·: 352.0 },
          { æ—¥æœŸ: "2023-12-30", æ”¶ç›˜ä»·: 355.0 },
          { æ—¥æœŸ: "2023-12-31", æ”¶ç›˜ä»·: 358.0 },
        ],
        data3: [
          { æ—¥æœŸ: "2020-01-02", æ”¶ç›˜ä»·: 3085.19 },
          { æ—¥æœŸ: "2020-01-03", æ”¶ç›˜ä»·: 3083.79 },
          { æ—¥æœŸ: "2020-01-06", æ”¶ç›˜ä»·: 3083.41 },
          { æ—¥æœŸ: "2020-01-07", æ”¶ç›˜ä»·: 3074.08 },
          { æ—¥æœŸ: "2020-01-08", æ”¶ç›˜ä»·: 3066.89 },
          { æ—¥æœŸ: "2023-12-28", æ”¶ç›˜ä»·: 2974.93 },
          { æ—¥æœŸ: "2023-12-29", æ”¶ç›˜ä»·: 2990.06 },
          { æ—¥æœŸ: "2023-12-30", æ”¶ç›˜ä»·: 3002.69 },
          { æ—¥æœŸ: "2023-12-31", æ”¶ç›˜ä»·: 3026.97 },
        ],
      };

      // å·¥å…·å‡½æ•°ï¼šæ—¥å¿—è¾“å‡º
      function log(msg) {
        logArea.innerHTML += new Date().toLocaleString() + " | " + msg + "\n";
        logArea.scrollTop = logArea.scrollHeight;
      }

      // å·¥å…·å‡½æ•°ï¼šè½¬æ¢Excelæ—¥æœŸåºåˆ—å·ä¸ºDateå¯¹è±¡
      function excelSerialToDate(serial) {
        if (typeof serial !== "number" || isNaN(serial)) return null;
        const baseDate = new Date(1899, 11, 30); // ä¿®æ­£Excelçš„1900é—°å¹´bug
        const date = new Date(baseDate.getTime() + serial * 86400000);
        return date;
      }

      // é€šç”¨æ—¥æœŸè½¬æ¢ï¼ˆå¼ºåˆ¶è¿”å›æœ‰æ•ˆDateå¯¹è±¡ï¼‰
      function toValidDate(dateInput) {
        if (!dateInput) throw new Error("æ—¥æœŸä¸èƒ½ä¸ºç©º");

        // å¤„ç†Excelæ—¥æœŸåºåˆ—å·
        if (typeof dateInput === "number" && !isNaN(dateInput)) {
          const excelDate = excelSerialToDate(dateInput);
          if (excelDate && !isNaN(excelDate.getTime())) {
            dateInput = excelDate;
          }
        }

        // å¤„ç†Dateå¯¹è±¡
        if (dateInput instanceof Date) {
          if (isNaN(dateInput.getTime())) {
            throw new Error(`æ— æ•ˆçš„Dateå¯¹è±¡ï¼š${dateInput}`);
          }
          const localDate = new Date(dateInput);
          localDate.setHours(0, 0, 0, 0);
          return localDate;
        }

        // å¤„ç†å­—ç¬¦ä¸²
        if (typeof dateInput === "string") {
          // å…¼å®¹ISOæ ¼å¼
          if (dateInput.includes("T") && dateInput.includes("Z")) {
            const utcDate = new Date(dateInput);
            const localDate = new Date(utcDate);
            localDate.setHours(0, 0, 0, 0);
            if (!isNaN(localDate.getTime())) {
              return localDate;
            }
          }

          // å…¼å®¹å„ç§æ—¥æœŸæ ¼å¼
          const cleanStr = dateInput
            .replace(/å¹´|æœˆ|æ—¥|\.|\/|\\/g, "-")
            .replace(/-+/g, "-")
            .trim();

          const date = new Date(cleanStr);
          if (isNaN(date.getTime())) {
            throw new Error(`æ— æ³•è§£ææ—¥æœŸï¼š${dateInput}ï¼ˆæ¨èæ ¼å¼ï¼š2019-11-15ï¼‰`);
          }
          date.setHours(0, 0, 0, 0);
          return date;
        }

        throw new Error(`ä¸æ”¯æŒçš„æ—¥æœŸç±»å‹ï¼š${typeof dateInput}ï¼ˆå€¼ï¼š${dateInput}ï¼‰`);
      }

      // è®¡ç®—ISOå‘¨æ•°
      function getISOWeek(date) {
        const validDate = toValidDate(date);
        const tempDate = new Date(validDate);
        tempDate.setHours(0, 0, 0, 0);

        tempDate.setDate(tempDate.getDate() + 3 - ((tempDate.getDay() + 6) % 7));
        const yearStart = new Date(tempDate.getFullYear(), 0, 1);
        const diffTime = tempDate - yearStart;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        const weekNo = Math.ceil((diffDays + 1) / 7);

        return tempDate.getFullYear() * 100 + weekNo;
      }

      // è®¡ç®—Yè½´èŒƒå›´
      function calculateYAxisRanges(data) {
        const allReturns = [
          ...data.map((row) => row["ä¸€æ¬¡æ€§ä¹°å…¥æ”¶ç›Šç‡"] * 100),
          ...data.map((row) => row["æ™®é€šå®šæŠ•æ”¶ç›Šç‡"] * 100),
          ...data.map((row) => row["åº•ä»“å®šæŠ•æ”¶ç›Šç‡"] * 100),
          ...data.map((row) => row["ä¸€æ¬¡æ€§ä¹°å…¥å¸‚å€¼æ”¶ç›Šç‡"] * 100),
          ...data.map((row) => row["æ™®é€šå®šæŠ•å¸‚å€¼æ”¶ç›Šç‡"] * 100),
          ...data.map((row) => row["åº•ä»“å®šæŠ•å¸‚å€¼æ”¶ç›Šç‡"] * 100),
        ];

        const allAmounts = [
          ...data.map((row) => row["ä¸€æ¬¡æ€§ä¹°å…¥ç´¯è®¡æŠ•å…¥"]),
          ...data.map((row) => row["æ™®é€šå®šæŠ•ç´¯è®¡æŠ•å…¥"]),
          ...data.map((row) => row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"]),
          ...data.map((row) => row["ä¸€æ¬¡æ€§ä¹°å…¥ç´¯è®¡æ”¶ç›Š"]),
          ...data.map((row) => row["æ™®é€šå®šæŠ•ç´¯è®¡æ”¶ç›Š"]),
          ...data.map((row) => row["åº•ä»“å®šæŠ•ç´¯è®¡æ”¶ç›Š"]),
        ];

        return {
          returnYMin: Math.min(...allReturns) * 1.1,
          returnYMax: Math.max(...allReturns) * 1.1,
          amountYMin: Math.min(...allAmounts) * 1.1,
          amountYMax: Math.max(...allAmounts) * 1.1,
        };
      }

      // æ•°æ®æºåˆ‡æ¢
      document.querySelectorAll(".data-source-tab").forEach((tab) => {
        tab.addEventListener("click", function () {
          document.querySelectorAll(".data-source-tab").forEach((t) => t.classList.remove("active"));
          document.querySelectorAll(".data-source-content").forEach((c) => c.classList.remove("active"));

          this.classList.add("active");
          document.getElementById(`${this.dataset.tab}-tab`).classList.add("active");
          currentDataSource = this.dataset.tab;

          rawData = null;
          document.getElementById("analyzeBtn").disabled = true;

          if (currentDataSource === "internal") {
            document.getElementById("internalDataSelect").value = "";
            document.getElementById("loadInternalDataBtn").disabled = true;
          } else {
            document.getElementById("fileInput").value = "";
          }

          log(`å·²åˆ‡æ¢åˆ°${currentDataSource === "internal" ? "å†…ç½®æ•°æ®" : "å¤–éƒ¨ä¸Šä¼ "}æ•°æ®æº`);
        });
      });

      // å†…ç½®æ•°æ®é€‰æ‹©å˜åŒ–
      document.getElementById("internalDataSelect").addEventListener("change", function () {
        document.getElementById("loadInternalDataBtn").disabled = !this.value;
      });

      // åŠ è½½å†…ç½®æ•°æ®
      document.getElementById("loadInternalDataBtn").addEventListener("click", function () {
        const selectedData = document.getElementById("internalDataSelect").value;
        if (!selectedData) return;

        const dataName = document.getElementById("internalDataSelect").options[
          document.getElementById("internalDataSelect").selectedIndex
        ].text;
        log(`å¼€å§‹åŠ è½½å†…ç½®æ•°æ®ï¼š${dataName}`);

        try {
          let data = JSON.parse(JSON.stringify(internalData[selectedData]));

          if (!data.length) {
            throw new Error("å†…ç½®æ•°æ®æ— æœ‰æ•ˆæ•°æ®è¡Œ");
          }
          if (!data[0].hasOwnProperty("æ—¥æœŸ") || !data[0].hasOwnProperty("æ”¶ç›˜ä»·")) {
            throw new Error("å†…ç½®æ•°æ®ç¼ºå°‘å¿…éœ€åˆ—ï¼šè¯·ç¡®ä¿åŒ…å«ã€Œæ—¥æœŸã€å’Œã€Œæ”¶ç›˜ä»·ã€åˆ—");
          }

          rawData = data
            .map((row, index) => {
              try {
                const æ—¥æœŸ = toValidDate(row["æ—¥æœŸ"]);
                const closePriceStr = (row["æ”¶ç›˜ä»·"] || "").toString().trim();
                const æ”¶ç›˜ä»· = parseFloat(closePriceStr);
                
                if (isNaN(æ”¶ç›˜ä»·) || æ”¶ç›˜ä»· <= 0) {
                  throw new Error(`æ”¶ç›˜ä»·å¿…é¡»æ˜¯æ­£æ•°ï¼ˆå½“å‰å€¼ï¼š${closePriceStr}ï¼‰`);
                }

                return { æ—¥æœŸ, æ”¶ç›˜ä»· };
              } catch (err) {
                throw new Error(`ç¬¬${index + 1}è¡Œæ•°æ®é”™è¯¯ï¼š${err.message}`);
              }
            })
            .filter((row) => row.æ—¥æœŸ instanceof Date && !isNaN(row.æ—¥æœŸ.getTime()))
            .sort((a, b) => a.æ—¥æœŸ - b.æ—¥æœŸ);

          if (rawData.length > 0) {
            const earliestDate = rawData[0].æ—¥æœŸ.toLocaleDateString();
            const latestDate = rawData[rawData.length - 1].æ—¥æœŸ.toLocaleDateString();
            log(`å†…ç½®æ•°æ®åŠ è½½æˆåŠŸï¼å…±${rawData.length}æ¡æœ‰æ•ˆè®°å½•`);
            log(`æ•°æ®æ—¶é—´èŒƒå›´ï¼š${earliestDate} è‡³ ${latestDate}`);
            log(`å‰5è¡Œæ•°æ®é¢„è§ˆï¼š${JSON.stringify(
              rawData.slice(0, 5).map((row) => ({
                æ—¥æœŸ: row.æ—¥æœŸ.toLocaleDateString(),
                æ”¶ç›˜ä»·: row.æ”¶ç›˜ä»·.toFixed(2),
              }))
            )}`);
          }

          document.getElementById("analyzeBtn").disabled = false;
        } catch (err) {
          log(`âŒ å†…ç½®æ•°æ®åŠ è½½å¤±è´¥ï¼š${err.message}`);
          rawData = null;
          document.getElementById("analyzeBtn").disabled = true;
        }
      });

      // æ–‡ä»¶ä¸Šä¼ å¤„ç†
      document.getElementById("uploadArea").addEventListener("click", () => {
        document.getElementById("fileInput").click();
      });

      // æ‹–æ‹½ä¸Šä¼ å¤„ç†
      const uploadArea = document.getElementById("uploadArea");
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = "#007bff";
        uploadArea.style.backgroundColor = "#f8f9fa";
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.style.borderColor = "#ccc";
        uploadArea.style.backgroundColor = "";
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = "#ccc";
        uploadArea.style.backgroundColor = "";
        
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          document.getElementById("fileInput").files = e.dataTransfer.files;
          handleFileUpload(e.dataTransfer.files[0]);
        }
      });

      // æ–‡ä»¶é€‰æ‹©å¤„ç†
      document.getElementById("fileInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          handleFileUpload(file);
        }
      });

      // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
      function handleFileUpload(file) {
        log(`å¼€å§‹è¯»å–æ–‡ä»¶ï¼š${file.name}`);
        const reader = new FileReader();

        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            let workbook;
            let rows = [];

            if (file.name.endsWith(".csv")) {
              // è§£æCSV
              const csvStr = new TextDecoder("gbk", { fatal: false }).decode(data);
              const lines = csvStr.split(/\r?\n/).filter((line) => line.trim());
              if (lines.length === 0) throw new Error("CSVæ–‡ä»¶æ— æœ‰æ•ˆæ•°æ®");

              const headers = lines[0].split(",").map((h) => h.trim());
              rows = lines.slice(1).map((line) => {
                const cells = line.split(",");
                const row = {};
                headers.forEach((h, i) => {
                  row[h] = cells[i] ? cells[i].trim() : "";
                });
                return row;
              });
            } else {
              // è§£æExcel
              workbook = XLSX.read(data, { type: "array" });
              const sheetName = workbook.SheetNames[0];
              const sheet = workbook.Sheets[sheetName];
              rows = XLSX.utils.sheet_to_json(sheet);
            }

            if (!rows.length) {
              throw new Error("æ–‡ä»¶æ— æœ‰æ•ˆæ•°æ®è¡Œ");
            }
            if (!rows[0].hasOwnProperty("æ—¥æœŸ") || !rows[0].hasOwnProperty("æ”¶ç›˜ä»·")) {
              throw new Error("æ–‡ä»¶ç¼ºå°‘å¿…éœ€åˆ—ï¼šè¯·ç¡®ä¿åŒ…å«ã€Œæ—¥æœŸã€å’Œã€Œæ”¶ç›˜ä»·ã€åˆ—");
            }

            rawData = rows
              .map((row, index) => {
                try {
                  const æ—¥æœŸ = toValidDate(row["æ—¥æœŸ"]);
                  const closePriceStr = (row["æ”¶ç›˜ä»·"] || "").toString().trim();
                  const æ”¶ç›˜ä»· = parseFloat(closePriceStr);
                  
                  if (isNaN(æ”¶ç›˜ä»·) || æ”¶ç›˜ä»· <= 0) {
                    throw new Error(`æ”¶ç›˜ä»·å¿…é¡»æ˜¯æ­£æ•°ï¼ˆå½“å‰å€¼ï¼š${closePriceStr}ï¼‰`);
                  }

                  return { æ—¥æœŸ, æ”¶ç›˜ä»· };
                } catch (err) {
                  throw new Error(`ç¬¬${index + 1}è¡Œæ•°æ®é”™è¯¯ï¼š${err.message}`);
                }
              })
              .filter((row) => row.æ—¥æœŸ instanceof Date && !isNaN(row.æ—¥æœŸ.getTime()))
              .sort((a, b) => a.æ—¥æœŸ - b.æ—¥æœŸ);

            if (rawData.length > 0) {
              const earliestDate = rawData[0].æ—¥æœŸ.toLocaleDateString();
              const latestDate = rawData[rawData.length - 1].æ—¥æœŸ.toLocaleDateString();
              log(`æ•°æ®åŠ è½½æˆåŠŸï¼å…±${rawData.length}æ¡æœ‰æ•ˆè®°å½•`);
              log(`æ•°æ®æ—¶é—´èŒƒå›´ï¼š${earliestDate} è‡³ ${latestDate}`);
              log(`å‰5è¡Œæ•°æ®é¢„è§ˆï¼š${JSON.stringify(
                rawData.slice(0, 5).map((row) => ({
                  æ—¥æœŸ: row.æ—¥æœŸ.toLocaleDateString(),
                  æ”¶ç›˜ä»·: row.æ”¶ç›˜ä»·.toFixed(2),
                }))
              )}`);
            }

            document.getElementById("analyzeBtn").disabled = false;
          } catch (err) {
            log(`âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼š${err.message}`);
            rawData = null;
            document.getElementById("analyzeBtn").disabled = true;
          }
        };

        reader.readAsArrayBuffer(file);
      }

      // ç­–ç•¥è®¡ç®—æ ¸å¿ƒå‡½æ•°
      function runStrategy() {
        log("å¼€å§‹è¿è¡Œç­–ç•¥è®¡ç®—...");

        // è·å–é…ç½®å‚æ•°
        const initialCapital = parseFloat(document.getElementById("initialCapital").value);
        const startDateStr = document.getElementById("startDate").value;
        const startDate = toValidDate(startDateStr);
        const endDateStr = document.getElementById("endDate").value;
        const endDate = toValidDate(endDateStr);
        const investAmount = parseFloat(document.getElementById("investAmount").value);
        const baseRatio = parseFloat(document.getElementById("baseRatio").value) / 100;
        const feeRate = parseFloat(document.getElementById("feeRate").value) / 100;

        // å‚æ•°æ ¡éªŒ
        if (isNaN(initialCapital) || initialCapital < 1000) {
          throw new Error(`åˆå§‹æœ¬é‡‘æ— æ•ˆï¼š${initialCapital}ï¼ˆæœ€å°å€¼1000å…ƒï¼‰`);
        }
        if (isNaN(investAmount) || investAmount < 100) {
          throw new Error(`å®šæŠ•é‡‘é¢æ— æ•ˆï¼š${investAmount}ï¼ˆæœ€å°å€¼100å…ƒï¼‰`);
        }
        if (isNaN(baseRatio) || baseRatio < 0 || baseRatio > 1) {
          throw new Error(`åº•ä»“æ¯”ä¾‹æ— æ•ˆï¼š${baseRatio * 100}%ï¼ˆèŒƒå›´0-100%ï¼‰`);
        }
        if (isNaN(feeRate) || feeRate < 0 || feeRate > 1) {
          throw new Error(`æ‰‹ç»­è´¹ç‡æ— æ•ˆï¼š${feeRate * 100}%ï¼ˆèŒƒå›´0-1%ï¼‰`);
        }
        if (startDate >= endDate) {
          throw new Error(`å¼€å§‹æ—¶é—´${startDate.toLocaleDateString()}ä¸èƒ½æ™šäºæˆ–ç­‰äºåœæ­¢æ—¶é—´${endDate.toLocaleDateString()}`);
        }

        // è¾“å‡ºæ—¶é—´èŒƒå›´ä¿¡æ¯
        const userStartDate = startDate.toLocaleDateString();
        const userEndDate = endDate.toLocaleDateString();
        const dataEarliestDate = rawData[0].æ—¥æœŸ.toLocaleDateString();
        const dataLatestDate = rawData[rawData.length - 1].æ—¥æœŸ.toLocaleDateString();
        log(`ç”¨æˆ·è®¾ç½®çš„æ—¶é—´èŒƒå›´ï¼š${userStartDate} è‡³ ${userEndDate}`);
        log(`æ•°æ®è¦†ç›–çš„æ—¥æœŸèŒƒå›´ï¼š${dataEarliestDate} è‡³ ${dataLatestDate}`);

        // æ ¡éªŒæ—¶é—´èŒƒå›´
        if (endDate < rawData[0].æ—¥æœŸ) {
          throw new Error(`åœæ­¢æ—¶é—´${userEndDate}æ—©äºæ•°æ®æœ€æ—©æ—¥æœŸ${dataEarliestDate}ï¼Œè¯·ä¿®æ”¹åœæ­¢æ—¶é—´`);
        }
        if (startDate > rawData[rawData.length - 1].æ—¥æœŸ) {
          throw new Error(`å¼€å§‹æ—¶é—´${userStartDate}æ™šäºæ•°æ®æœ€æ™šæ—¥æœŸ${dataLatestDate}ï¼Œè¯·ä¿®æ”¹å¼€å§‹æ—¶é—´`);
        }

        // åˆå§‹åŒ–ç»“æœæ•°æ®
        const data = JSON.parse(JSON.stringify(rawData));
        const tradeLog = [];

        // åˆå§‹åŒ–æ‰€æœ‰ç­–ç•¥å­—æ®µ
        data.forEach((row) => {
          // ä¸€æ¬¡æ€§ä¹°å…¥ç­–ç•¥
          row["ä¸€æ¬¡æ€§ä¹°å…¥æ€»èµ„äº§"] = initialCapital;
          row["ä¸€æ¬¡æ€§ä¹°å…¥å¸‚å€¼"] = 0.0;
          row["ä¸€æ¬¡æ€§ä¹°å…¥æ”¶ç›Šç‡"] = 0.0;
          row["ä¸€æ¬¡æ€§ä¹°å…¥ç´¯è®¡æŠ•å…¥"] = 0.0;

          // æ™®é€šå®šæŠ•ç­–ç•¥
          row["æ™®é€šå®šæŠ•è‚¡ç¥¨æ•°é‡"] = 0.0;
          row["æ™®é€šå®šæŠ•ç°é‡‘"] = initialCapital;
          row["æ™®é€šå®šæŠ•æ€»èµ„äº§"] = initialCapital;
          row["æ™®é€šå®šæŠ•å¸‚å€¼"] = 0.0;
          row["æ™®é€šå®šæŠ•æ”¶ç›Šç‡"] = 0.0;
          row["æ™®é€šå®šæŠ•ç´¯è®¡æŠ•å…¥"] = 0.0;
          row["æ™®é€šå®šæŠ•ä¿¡å·"] = null;

          // åº•ä»“å®šæŠ•ç­–ç•¥
          row["åº•ä»“å®šæŠ•åº•ä»“è‚¡ç¥¨æ•°é‡"] = 0.0;
          row["åº•ä»“å®šæŠ•æµ®åŠ¨ä»“è‚¡ç¥¨æ•°é‡"] = 0.0;
          row["åº•ä»“å®šæŠ•ç°é‡‘"] = initialCapital;
          row["åº•ä»“å®šæŠ•æ€»èµ„äº§"] = initialCapital;
          row["åº•ä»“å®šæŠ•å¸‚å€¼"] = 0.0;
          row["åº•ä»“å®šæŠ•æ”¶ç›Šç‡"] = 0.0;
          row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"] = 0.0;
          row["åº•ä»“å®šæŠ•ä¿¡å·"] = null;
        });

        // æŸ¥æ‰¾å¼€å§‹ç´¢å¼•
        let buyOnceStartIdx = data.findIndex((row) => {
          const rowDate = new Date(row.æ—¥æœŸ);
          const targetDate = new Date(startDate);
          return (
            rowDate.getFullYear() > targetDate.getFullYear() ||
            (rowDate.getFullYear() === targetDate.getFullYear() && rowDate.getMonth() > targetDate.getMonth()) ||
            (rowDate.getFullYear() === targetDate.getFullYear() && rowDate.getMonth() === targetDate.getMonth() && rowDate.getDate() >= targetDate.getDate())
          );
        });

        log(`è°ƒè¯•ï¼šfindIndexæŸ¥æ‰¾${userStartDate}ç»“æœç´¢å¼•ï¼š${buyOnceStartIdx}`);

        // å®¹é”™å¤„ç†
        if (buyOnceStartIdx === -1) {
          if (startDate < data[0].æ—¥æœŸ) {
            buyOnceStartIdx = 0;
            log(`âš ï¸ å¼€å§‹æ—¥æœŸ${userStartDate}æ—©äºæ•°æ®æœ€æ—©æ—¥æœŸ${dataEarliestDate}ï¼Œè‡ªåŠ¨ä½¿ç”¨æ•°æ®æœ€æ—©æ—¥æœŸä½œä¸ºå¼€å§‹ç‚¹`);
          } else if (startDate > data[data.length - 1].æ—¥æœŸ) {
            throw new Error(`å¼€å§‹æ—¥æœŸ${userStartDate}æ™šäºæ•°æ®æœ€æ™šæ—¥æœŸ${dataLatestDate}ï¼Œè¯·ä¿®æ”¹å¼€å§‹æ—¥æœŸ`);
          } else {
            for (let i = 0; i < data.length; i++) {
              if (data[i].æ—¥æœŸ > startDate) {
                buyOnceStartIdx = i;
                log(`âš ï¸ æ•°æ®ä¸­æ— ${userStartDate}çš„è®°å½•ï¼Œè‡ªåŠ¨ä½¿ç”¨æœ€è¿‘çš„${data[i].æ—¥æœŸ.toLocaleDateString()}ä½œä¸ºå¼€å§‹ç‚¹`);
                break;
              }
            }
            if (buyOnceStartIdx === -1) {
              buyOnceStartIdx = data.length - 1;
              log(`âš ï¸ æœªæ‰¾åˆ°åŒ¹é…æ—¥æœŸï¼Œä½¿ç”¨æ•°æ®æœ€åä¸€æ¡è®°å½•${dataLatestDate}ä½œä¸ºå¼€å§‹ç‚¹`);
            }
          }
        }

        // æŸ¥æ‰¾åœæ­¢ç´¢å¼•
        let endIdx = data.findIndex((row) => {
          const rowDate = new Date(row.æ—¥æœŸ);
          const targetDate = new Date(endDate);
          return (
            rowDate.getFullYear() > targetDate.getFullYear() ||
            (rowDate.getFullYear() === targetDate.getFullYear() && rowDate.getMonth() > targetDate.getMonth()) ||
            (rowDate.getFullYear() === targetDate.getFullYear() && rowDate.getMonth() === targetDate.getMonth() && rowDate.getDate() > targetDate.getDate())
          );
        });

        if (endIdx === -1) {
          endIdx = data.length - 1;
          log(`âš ï¸ æ•°æ®ä¸­æ— ${userEndDate}çš„è®°å½•ï¼Œè‡ªåŠ¨ä½¿ç”¨æ•°æ®æœ€åä¸€æ¡è®°å½•${dataLatestDate}ä½œä¸ºåœæ­¢ç‚¹`);
        } else {
          endIdx = Math.max(endIdx - 1, buyOnceStartIdx);
        }

        log(`è°ƒè¯•ï¼šç­–ç•¥è®¡ç®—èŒƒå›´ç´¢å¼•ï¼š${buyOnceStartIdx} è‡³ ${endIdx}`);

        const regularInvestStartIdx = buyOnceStartIdx;
        const baseInvestStartIdx = buyOnceStartIdx;

        // ä¸€æ¬¡æ€§ä¹°å…¥ç­–ç•¥ - ä¿®å¤ï¼šéå†æ‰€æœ‰æ•°æ®è¡Œï¼Œè€Œéä»…åˆ°endIdx
        if (buyOnceStartIdx >= 0) {
          const startPrice = data[buyOnceStartIdx].æ”¶ç›˜ä»·;
          const buyableShares = (initialCapital * (1 - feeRate)) / startPrice;

          // ğŸ”¥ å…³é”®ä¿®æ”¹1ï¼šéå†æ‰€æœ‰æ•°æ®è¡Œï¼Œç¡®ä¿åœæ­¢æ—¶é—´åæ”¶ç›Šç‡ä»æ›´æ–°
          for (let i = 0; i < data.length; i++) {
            if (i >= buyOnceStartIdx) {
              data[i]["ä¸€æ¬¡æ€§ä¹°å…¥å¸‚å€¼"] = buyableShares * data[i].æ”¶ç›˜ä»·;
              data[i]["ä¸€æ¬¡æ€§ä¹°å…¥æ€»èµ„äº§"] = data[i]["ä¸€æ¬¡æ€§ä¹°å…¥å¸‚å€¼"];
              data[i]["ä¸€æ¬¡æ€§ä¹°å…¥æ”¶ç›Šç‡"] = (data[i]["ä¸€æ¬¡æ€§ä¹°å…¥æ€»èµ„äº§"] - initialCapital) / initialCapital;
              data[i]["ä¸€æ¬¡æ€§ä¹°å…¥ç´¯è®¡æŠ•å…¥"] = initialCapital;
            } else {
              // ä¹°å…¥å‰çš„æ•°æ®ä¿æŒåˆå§‹å€¼
              data[i]["ä¸€æ¬¡æ€§ä¹°å…¥å¸‚å€¼"] = 0;
              data[i]["ä¸€æ¬¡æ€§ä¹°å…¥æ€»èµ„äº§"] = initialCapital;
              data[i]["ä¸€æ¬¡æ€§ä¹°å…¥æ”¶ç›Šç‡"] = 0;
              data[i]["ä¸€æ¬¡æ€§ä¹°å…¥ç´¯è®¡æŠ•å…¥"] = 0;
            }
          }
          log(`âœ… ä¸€æ¬¡æ€§ä¹°å…¥ç­–ç•¥ï¼š${buyableShares.toFixed(2)}è‚¡ï¼Œä¹°å…¥ä»·${startPrice.toFixed(2)}å…ƒ`);
        } else {
          throw new Error(`å¼€å§‹æ—¥æœŸ${startDate.toLocaleDateString()}è¶…å‡ºæ•°æ®æ—¶é—´èŒƒå›´`);
        }

        // æ™®é€šå®šæŠ•ç­–ç•¥
        const regularInvestWeeks = new Set();
        let prevRegularCash = initialCapital;
        let prevRegularShares = 0.0;
        let prevRegularInvested = 0.0;

        for (let i = 0; i < data.length; i++) {
          const row = data[i];
          if (i >= regularInvestStartIdx && i <= endIdx) {
            const currentWeek = getISOWeek(row.æ—¥æœŸ);
            const startRow = data[regularInvestStartIdx];
            const startWeek = getISOWeek(startRow.æ—¥æœŸ);
            const weekDiff = currentWeek - startWeek;
            const isInvestDay = weekDiff >= 0 && weekDiff % 1 === 0 && !regularInvestWeeks.has(currentWeek);

            if (isInvestDay && prevRegularCash >= investAmount) {
              const buyableAmount = investAmount * (1 - feeRate);
              const buyableShares = buyableAmount / row.æ”¶ç›˜ä»·;

              prevRegularShares += buyableShares;
              prevRegularCash -= investAmount;
              prevRegularInvested += investAmount;

              row["æ™®é€šå®šæŠ•è‚¡ç¥¨æ•°é‡"] = prevRegularShares;
              row["æ™®é€šå®šæŠ•ç°é‡‘"] = prevRegularCash;
              row["æ™®é€šå®šæŠ•ç´¯è®¡æŠ•å…¥"] = prevRegularInvested;
              row["æ™®é€šå®šæŠ•ä¿¡å·"] = "å®šæŠ•ä¹°å…¥";

              regularInvestWeeks.add(currentWeek);
              tradeLog.push({
                æ—¥æœŸ: toValidDate(row.æ—¥æœŸ),
                ç±»å‹: "æ™®é€šå®šæŠ•ä¹°å…¥",
                ä»·æ ¼: row.æ”¶ç›˜ä»·,
                æ•°é‡: buyableShares,
              });
            } else {
              row["æ™®é€šå®šæŠ•è‚¡ç¥¨æ•°é‡"] = prevRegularShares;
              row["æ™®é€šå®šæŠ•ç°é‡‘"] = prevRegularCash;
              row["æ™®é€šå®šæŠ•ç´¯è®¡æŠ•å…¥"] = prevRegularInvested;
            }

            row["æ™®é€šå®šæŠ•å¸‚å€¼"] = prevRegularShares * row.æ”¶ç›˜ä»·;
            row["æ™®é€šå®šæŠ•æ€»èµ„äº§"] = row["æ™®é€šå®šæŠ•å¸‚å€¼"] + prevRegularCash;
            row["æ™®é€šå®šæŠ•æ”¶ç›Šç‡"] = (row["æ™®é€šå®šæŠ•æ€»èµ„äº§"] - initialCapital) / initialCapital;
          } else if (i > endIdx) {
            // åœæ­¢å®šæŠ•åï¼Œä»…æ›´æ–°å¸‚å€¼å’Œæ”¶ç›Šç‡ï¼Œä¸è¿›è¡Œæ–°çš„å®šæŠ•
            row["æ™®é€šå®šæŠ•è‚¡ç¥¨æ•°é‡"] = prevRegularShares;
            row["æ™®é€šå®šæŠ•ç°é‡‘"] = prevRegularCash;
            row["æ™®é€šå®šæŠ•ç´¯è®¡æŠ•å…¥"] = prevRegularInvested;
            row["æ™®é€šå®šæŠ•å¸‚å€¼"] = prevRegularShares * row.æ”¶ç›˜ä»·;
            row["æ™®é€šå®šæŠ•æ€»èµ„äº§"] = row["æ™®é€šå®šæŠ•å¸‚å€¼"] + prevRegularCash;
            row["æ™®é€šå®šæŠ•æ”¶ç›Šç‡"] = (row["æ™®é€šå®šæŠ•æ€»èµ„äº§"] - initialCapital) / initialCapital;
          } else {
            // å®šæŠ•å¼€å§‹å‰
            row["æ™®é€šå®šæŠ•è‚¡ç¥¨æ•°é‡"] = 0;
            row["æ™®é€šå®šæŠ•ç°é‡‘"] = initialCapital;
            row["æ™®é€šå®šæŠ•ç´¯è®¡æŠ•å…¥"] = 0;
            row["æ™®é€šå®šæŠ•å¸‚å€¼"] = 0;
            row["æ™®é€šå®šæŠ•æ€»èµ„äº§"] = initialCapital;
            row["æ™®é€šå®šæŠ•æ”¶ç›Šç‡"] = 0;
          }
        }
        log(`âœ… æ™®é€šå®šæŠ•ç­–ç•¥ï¼šå…±å®šæŠ•${regularInvestWeeks.size}æ¬¡ï¼Œç´¯è®¡æŠ•å…¥${prevRegularInvested.toFixed(2)}å…ƒ`);

        // åº•ä»“å®šæŠ•ç­–ç•¥
        const baseInvestWeeks = new Set();
        let baseEstablished = false;
        let prevBaseCash = initialCapital;
        let prevBaseShares = 0.0;
        let prevFloatShares = 0.0;
        let prevBaseInvested = 0.0;

        for (let i = 0; i < data.length; i++) {
          const row = data[i];
          if (i >= baseInvestStartIdx && i <= endIdx) {
            // åº•ä»“å»ºä»“
            if (!baseEstablished && i === baseInvestStartIdx) {
              const baseAmount = initialCapital * baseRatio;
              const buyableAmount = baseAmount * (1 - feeRate);
              const buyableShares = buyableAmount / row.æ”¶ç›˜ä»·;

              prevBaseShares = buyableShares;
              prevBaseCash -= baseAmount;
              prevBaseInvested += baseAmount;

              row["åº•ä»“å®šæŠ•åº•ä»“è‚¡ç¥¨æ•°é‡"] = prevBaseShares;
              row["åº•ä»“å®šæŠ•ç°é‡‘"] = prevBaseCash;
              row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"] = prevBaseInvested;

              baseEstablished = true;
              tradeLog.push({
                æ—¥æœŸ: toValidDate(row.æ—¥æœŸ),
                ç±»å‹: "åº•ä»“å»ºä»“ä¹°å…¥",
                ä»·æ ¼: row.æ”¶ç›˜ä»·,
                æ•°é‡: buyableShares,
              });
              log(`âœ… åº•ä»“å»ºä»“ï¼š${buyableShares.toFixed(2)}è‚¡ï¼Œä¹°å…¥ä»·${row.æ”¶ç›˜ä»·.toFixed(2)}å…ƒ`);
            } else {
              row["åº•ä»“å®šæŠ•åº•ä»“è‚¡ç¥¨æ•°é‡"] = prevBaseShares;
              row["åº•ä»“å®šæŠ•ç°é‡‘"] = prevBaseCash;
              row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"] = prevBaseInvested;
            }

            // æµ®åŠ¨ä»“å®šæŠ•
            if (baseEstablished) {
              const currentWeek = getISOWeek(row.æ—¥æœŸ);
              const startRow = data[baseInvestStartIdx];
              const startWeek = getISOWeek(startRow.æ—¥æœŸ);
              const weekDiff = currentWeek - startWeek;
              const isInvestDay = weekDiff >= 0 && weekDiff % 1 === 0 && !baseInvestWeeks.has(currentWeek);

              if (isInvestDay && prevBaseCash >= investAmount) {
                const buyableAmount = investAmount * (1 - feeRate);
                const buyableShares = buyableAmount / row.æ”¶ç›˜ä»·;

                prevFloatShares += buyableShares;
                prevBaseCash -= investAmount;
                prevBaseInvested += investAmount;

                row["åº•ä»“å®šæŠ•æµ®åŠ¨ä»“è‚¡ç¥¨æ•°é‡"] = prevFloatShares;
                row["åº•ä»“å®šæŠ•ç°é‡‘"] = prevBaseCash;
                row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"] = prevBaseInvested;
                row["åº•ä»“å®šæŠ•ä¿¡å·"] = "å®šæŠ•ä¹°å…¥";

                baseInvestWeeks.add(currentWeek);
                tradeLog.push({
                  æ—¥æœŸ: toValidDate(row.æ—¥æœŸ),
                  ç±»å‹: "åº•ä»“å®šæŠ•ä¹°å…¥",
                  ä»·æ ¼: row.æ”¶ç›˜ä»·,
                  æ•°é‡: buyableShares,
                });
              } else {
                row["åº•ä»“å®šæŠ•æµ®åŠ¨ä»“è‚¡ç¥¨æ•°é‡"] = prevFloatShares;
              }
            }

            // æ›´æ–°å¸‚å€¼å’Œæ”¶ç›Šç‡
            const baseMarketValue = prevBaseShares * row.æ”¶ç›˜ä»·;
            const floatMarketValue = prevFloatShares * row.æ”¶ç›˜ä»·;
            row["åº•ä»“å®šæŠ•å¸‚å€¼"] = baseMarketValue + floatMarketValue;
            row["åº•ä»“å®šæŠ•æ€»èµ„äº§"] = row["åº•ä»“å®šæŠ•å¸‚å€¼"] + prevBaseCash;
            row["åº•ä»“å®šæŠ•æ”¶ç›Šç‡"] = (row["åº•ä»“å®šæŠ•æ€»èµ„äº§"] - initialCapital) / initialCapital;
          } else if (i > endIdx) {
            // åœæ­¢å®šæŠ•åï¼Œä»…æ›´æ–°å¸‚å€¼å’Œæ”¶ç›Šç‡ï¼Œä¸è¿›è¡Œæ–°çš„å®šæŠ•
            row["åº•ä»“å®šæŠ•åº•ä»“è‚¡ç¥¨æ•°é‡"] = prevBaseShares;
            row["åº•ä»“å®šæŠ•æµ®åŠ¨ä»“è‚¡ç¥¨æ•°é‡"] = prevFloatShares;
            row["åº•ä»“å®šæŠ•ç°é‡‘"] = prevBaseCash;
            row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"] = prevBaseInvested;
            
            const baseMarketValue = prevBaseShares * row.æ”¶ç›˜ä»·;
            const floatMarketValue = prevFloatShares * row.æ”¶ç›˜ä»·;
            row["åº•ä»“å®šæŠ•å¸‚å€¼"] = baseMarketValue + floatMarketValue;
            row["åº•ä»“å®šæŠ•æ€»èµ„äº§"] = row["åº•ä»“å®šæŠ•å¸‚å€¼"] + prevBaseCash;
            row["åº•ä»“å®šæŠ•æ”¶ç›Šç‡"] = (row["åº•ä»“å®šæŠ•æ€»èµ„äº§"] - initialCapital) / initialCapital;
          } else {
            // å®šæŠ•å¼€å§‹å‰
            row["åº•ä»“å®šæŠ•åº•ä»“è‚¡ç¥¨æ•°é‡"] = 0;
            row["åº•ä»“å®šæŠ•æµ®åŠ¨ä»“è‚¡ç¥¨æ•°é‡"] = 0;
            row["åº•ä»“å®šæŠ•ç°é‡‘"] = initialCapital;
            row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"] = 0;
            row["åº•ä»“å®šæŠ•å¸‚å€¼"] = 0;
            row["åº•ä»“å®šæŠ•æ€»èµ„äº§"] = initialCapital;
            row["åº•ä»“å®šæŠ•æ”¶ç›Šç‡"] = 0;
          }
        }
        log(`âœ… åº•ä»“å®šæŠ•ç­–ç•¥ï¼šåº•ä»“${baseRatio * 100}% + å®šæŠ•${baseInvestWeeks.size}æ¬¡ï¼Œç´¯è®¡æŠ•å…¥${prevBaseInvested.toFixed(2)}å…ƒ`);

        // è®¡ç®—å¸‚å€¼æ”¶ç›Šç‡å’Œç´¯è®¡æ”¶ç›Š
        data.forEach((row) => {
          row["ä¸€æ¬¡æ€§ä¹°å…¥å¸‚å€¼æ”¶ç›Šç‡"] = row["ä¸€æ¬¡æ€§ä¹°å…¥å¸‚å€¼"] > 0 
            ? (row["ä¸€æ¬¡æ€§ä¹°å…¥å¸‚å€¼"] - initialCapital) / initialCapital 
            : 0;

          row["æ™®é€šå®šæŠ•å¸‚å€¼æ”¶ç›Šç‡"] = row["æ™®é€šå®šæŠ•ç´¯è®¡æŠ•å…¥"] > 0 
            ? (row["æ™®é€šå®šæŠ•å¸‚å€¼"] - row["æ™®é€šå®šæŠ•ç´¯è®¡æŠ•å…¥"]) / row["æ™®é€šå®šæŠ•ç´¯è®¡æŠ•å…¥"] 
            : 0;

          row["åº•ä»“å®šæŠ•å¸‚å€¼æ”¶ç›Šç‡"] = row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"] > 0 
            ? (row["åº•ä»“å®šæŠ•å¸‚å€¼"] - row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"]) / row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"] 
            : 0;

          row["ä¸€æ¬¡æ€§ä¹°å…¥ç´¯è®¡æ”¶ç›Š"] = row["ä¸€æ¬¡æ€§ä¹°å…¥æ€»èµ„äº§"] - initialCapital;
          row["æ™®é€šå®šæŠ•ç´¯è®¡æ”¶ç›Š"] = row["æ™®é€šå®šæŠ•æ€»èµ„äº§"] - initialCapital;
          row["åº•ä»“å®šæŠ•ç´¯è®¡æ”¶ç›Š"] = row["åº•ä»“å®šæŠ•æ€»èµ„äº§"] - initialCapital;
        });

        log(`âœ… ç­–ç•¥è®¡ç®—å®Œæˆï¼å…±ç”Ÿæˆ${tradeLog.length}ç¬”äº¤æ˜“è®°å½•`);
        log(`ğŸ“ æœ€è¿‘10ç¬”äº¤æ˜“ï¼š${JSON.stringify(
          tradeLog.slice(-10).map((t) => {
            const validDate = toValidDate(t.æ—¥æœŸ);
            return {
              æ—¥æœŸ: validDate.toLocaleDateString(),
              ç±»å‹: t.ç±»å‹,
              ä»·æ ¼: t.ä»·æ ¼.toFixed(2),
              æ•°é‡: t.æ•°é‡.toFixed(2),
            };
          }),
          null,
          2
        )}`);

        return { data, tradeLog };
      }

      // ç»˜åˆ¶æ”¶ç›Šç‡å›¾è¡¨
      function drawReturnChart(data, yRanges) {
        log("å¼€å§‹ç”Ÿæˆæ”¶ç›Šç‡å¯¹æ¯”å›¾è¡¨...");
        const chartArea1 = document.getElementById("chartArea1");
        chartArea1.classList.remove("hidden");

        // å‡†å¤‡å›¾è¡¨æ•°æ®
        const dates = data.map((row) => row.æ—¥æœŸ);
        const buyOnceReturn = data.map((row) => row["ä¸€æ¬¡æ€§ä¹°å…¥æ”¶ç›Šç‡"] * 100);
        const regularReturn = data.map((row) => row["æ™®é€šå®šæŠ•æ”¶ç›Šç‡"] * 100);
        const baseReturn = data.map((row) => row["åº•ä»“å®šæŠ•æ”¶ç›Šç‡"] * 100);

        const buyOnceMarketReturn = data.map((row) => row["ä¸€æ¬¡æ€§ä¹°å…¥å¸‚å€¼æ”¶ç›Šç‡"] * 100);
        const regularMarketReturn = data.map((row) => row["æ™®é€šå®šæŠ•å¸‚å€¼æ”¶ç›Šç‡"] * 100);
        const baseMarketReturn = data.map((row) => row["åº•ä»“å®šæŠ•å¸‚å€¼æ”¶ç›Šç‡"] * 100);

        // æå–å®šæŠ•ä¹°å…¥ç‚¹
        const regularInvestPoints = data
          .filter((row) => row["æ™®é€šå®šæŠ•ä¿¡å·"] === "å®šæŠ•ä¹°å…¥")
          .map((row) => ({ x: row.æ—¥æœŸ, y: row["æ™®é€šå®šæŠ•æ”¶ç›Šç‡"] * 100 }));

        const baseInvestPoints = data
          .filter((row) => row["åº•ä»“å®šæŠ•ä¿¡å·"] === "å®šæŠ•ä¹°å…¥")
          .map((row) => ({ x: row.æ—¥æœŸ, y: row["åº•ä»“å®šæŠ•æ”¶ç›Šç‡"] * 100 }));

        // å®šä¹‰å›¾è¡¨è½¨è¿¹
        const traces = [
          // å·¦Yè½´ - æ€»æ”¶ç›Šç‡
          {
            x: dates,
            y: buyOnceReturn,
            name: "ä¸€æ¬¡æ€§ä¹°å…¥ï¼ˆæ€»æ”¶ç›Šç‡%ï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#ff7f0e", width: 2 },
            yaxis: "y1",
          },
          {
            x: dates,
            y: regularReturn,
            name: "æ™®é€šå®šæŠ•ï¼ˆæ€»æ”¶ç›Šç‡%ï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#2ca02c", width: 2 },
            yaxis: "y1",
          },
          {
            x: dates,
            y: baseReturn,
            name: "50%åº•ä»“+å®šæŠ•ï¼ˆæ€»æ”¶ç›Šç‡%ï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#1f77b4", width: 2 },
            yaxis: "y1",
          },
          // å®šæŠ•ä¹°å…¥ç‚¹æ ‡è®°
          {
            x: regularInvestPoints.map((p) => p.x),
            y: regularInvestPoints.map((p) => p.y),
            name: "æ™®é€šå®šæŠ•ä¹°å…¥ç‚¹",
            type: "scatter",
            mode: "markers",
            marker: { color: "#17becf", size: 8, symbol: "circle" },
            yaxis: "y1",
          },
          {
            x: baseInvestPoints.map((p) => p.x),
            y: baseInvestPoints.map((p) => p.y),
            name: "åº•ä»“å®šæŠ•ä¹°å…¥ç‚¹",
            type: "scatter",
            mode: "markers",
            marker: { color: "#9467bd", size: 8, symbol: "diamond" },
            yaxis: "y1",
          },
          // å³Yè½´ - æŒæœ‰æ”¶ç›Šç‡
          {
            x: dates,
            y: buyOnceMarketReturn,
            name: "ä¸€æ¬¡æ€§ä¹°å…¥ï¼ˆæŒæœ‰æ”¶ç›Šç‡%ï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#ff7f0e", width: 2, dash: "dash" },
            yaxis: "y2",
          },
          {
            x: dates,
            y: regularMarketReturn,
            name: "æ™®é€šå®šæŠ•ï¼ˆæŒæœ‰æ”¶ç›Šç‡%ï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#2ca02c", width: 2, dash: "dash" },
            yaxis: "y2",
          },
          {
            x: dates,
            y: baseMarketReturn,
            name: "50%åº•ä»“+å®šæŠ•ï¼ˆæŒæœ‰æ”¶ç›Šç‡%ï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#1f77b4", width: 2, dash: "dash" },
            yaxis: "y2",
          },
        ];

        // å›¾è¡¨å¸ƒå±€ - ğŸ”¥ å…³é”®ä¿®æ”¹2ï¼šæ·»åŠ å“åº”å¼é…ç½®
        const layout = {
          title: "è‚¡ç¥¨å®šæŠ•æ”¶ç›Šç‡å¯¹æ¯”",
          autosize: true, // è‡ªåŠ¨è°ƒæ•´å°ºå¯¸
          height: 600, // åŸºç¡€é«˜åº¦ï¼Œautosizeä¼šæ ¹æ®å®¹å™¨è°ƒæ•´
          xaxis: {
            title: "æ—¥æœŸ",
            type: "date",
            tickformat: "%Y-%m-%d",
            tickangle: -45,
            automargin: true, // è‡ªåŠ¨è°ƒæ•´è¾¹è·ï¼Œé˜²æ­¢æ ‡ç­¾è¢«æˆªæ–­
          },
          yaxis: {
            title: "æ€»æ”¶ç›Šç‡ (%)",
            range: [yRanges.returnYMin, yRanges.returnYMax],
            side: "left",
            titlefont: { color: "#333" },
            tickfont: { color: "#333" },
            automargin: true,
          },
          yaxis2: {
            title: "æŒæœ‰æ”¶ç›Šç‡ (%)",
            range: [yRanges.returnYMin, yRanges.returnYMax],
            side: "right",
            overlaying: "y",
            titlefont: { color: "#888" },
            tickfont: { color: "#888" },
            automargin: true,
          },
          legend: {
            x: 0,
            y: 1,
            bgcolor: "rgba(255,255,255,0.8)",
            orientation: "h", // æ°´å¹³æ’åˆ—å›¾ä¾‹ï¼ŒèŠ‚çœå‚ç›´ç©ºé—´
            xanchor: "left",
            yanchor: "top",
          },
          hovermode: "x unified",
          margin: { l: 80, r: 80, t: 60, b: 80 }, // å¢åŠ è¾¹è·ï¼Œé˜²æ­¢å†…å®¹è¢«æˆªæ–­
          responsive: true, // å¯ç”¨å“åº”å¼
        };

        // ç»˜åˆ¶å›¾è¡¨
        Plotly.newPlot("chartArea1", traces, layout);
      }

      // ç»˜åˆ¶é‡‘é¢å¯¹æ¯”å›¾è¡¨
      function drawAmountChart(data, yRanges) {
        log("å¼€å§‹ç”Ÿæˆé‡‘é¢å¯¹æ¯”å›¾è¡¨...");
        const chartArea2 = document.getElementById("chartArea2");
        chartArea2.classList.remove("hidden");

        // å‡†å¤‡å›¾è¡¨æ•°æ®
        const dates = data.map((row) => row.æ—¥æœŸ);
        const buyOnceInvest = data.map((row) => row["ä¸€æ¬¡æ€§ä¹°å…¥ç´¯è®¡æŠ•å…¥"]);
        const regularInvest = data.map((row) => row["æ™®é€šå®šæŠ•ç´¯è®¡æŠ•å…¥"]);
        const baseInvest = data.map((row) => row["åº•ä»“å®šæŠ•ç´¯è®¡æŠ•å…¥"]);

        const buyOnceProfit = data.map((row) => row["ä¸€æ¬¡æ€§ä¹°å…¥ç´¯è®¡æ”¶ç›Š"]);
        const regularProfit = data.map((row) => row["æ™®é€šå®šæŠ•ç´¯è®¡æ”¶ç›Š"]);
        const baseProfit = data.map((row) => row["åº•ä»“å®šæŠ•ç´¯è®¡æ”¶ç›Š"]);

        // å®šä¹‰å›¾è¡¨è½¨è¿¹
        const traces = [
          // ç´¯è®¡æŠ•å…¥
          {
            x: dates,
            y: buyOnceInvest,
            name: "ä¸€æ¬¡æ€§ä¹°å…¥ï¼ˆç´¯è®¡æŠ•å…¥ï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#ff7f0e", width: 2 },
            yaxis: "y1",
          },
          {
            x: dates,
            y: regularInvest,
            name: "æ™®é€šå®šæŠ•ï¼ˆç´¯è®¡æŠ•å…¥ï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#2ca02c", width: 2 },
            yaxis: "y1",
          },
          {
            x: dates,
            y: baseInvest,
            name: "50%åº•ä»“+å®šæŠ•ï¼ˆç´¯è®¡æŠ•å…¥ï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#1f77b4", width: 2 },
            yaxis: "y1",
          },
          // ç´¯è®¡æ”¶ç›Š
          {
            x: dates,
            y: buyOnceProfit,
            name: "ä¸€æ¬¡æ€§ä¹°å…¥ï¼ˆç´¯è®¡æ”¶ç›Šï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#ff7f0e", width: 2, dash: "dash" },
            yaxis: "y2",
          },
          {
            x: dates,
            y: regularProfit,
            name: "æ™®é€šå®šæŠ•ï¼ˆç´¯è®¡æ”¶ç›Šï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#2ca02c", width: 2, dash: "dash" },
            yaxis: "y2",
          },
          {
            x: dates,
            y: baseProfit,
            name: "50%åº•ä»“+å®šæŠ•ï¼ˆç´¯è®¡æ”¶ç›Šï¼‰",
            type: "scatter",
            mode: "lines",
            line: { color: "#1f77b4", width: 2, dash: "dash" },
            yaxis: "y2",
          },
        ];

        // å›¾è¡¨å¸ƒå±€ - ğŸ”¥ å…³é”®ä¿®æ”¹3ï¼šæ·»åŠ å“åº”å¼é…ç½®
        const layout = {
          title: "è‚¡ç¥¨å®šæŠ•é‡‘é¢å¯¹æ¯”",
          autosize: true,
          height: 600,
          xaxis: {
            title: "æ—¥æœŸ",
            type: "date",
            tickformat: "%Y-%m-%d",
            tickangle: -45,
            automargin: true,
          },
          yaxis: {
            title: "ç´¯è®¡æŠ•å…¥ (å…ƒ)",
            range: [yRanges.amountYMin, yRanges.amountYMax],
            side: "left",
            titlefont: { color: "#333" },
            tickfont: { color: "#333" },
            automargin: true,
          },
          yaxis2: {
            title: "ç´¯è®¡æ”¶ç›Š (å…ƒ)",
            range: [yRanges.amountYMin, yRanges.amountYMax],
            side: "right",
            overlaying: "y",
            titlefont: { color: "#888" },
            tickfont: { color: "#888" },
            automargin: true,
          },
          legend: {
            x: 0,
            y: 1,
            bgcolor: "rgba(255,255,255,0.8)",
            orientation: "h",
            xanchor: "left",
            yanchor: "top",
          },
          hovermode: "x unified",
          margin: { l: 80, r: 80, t: 60, b: 80 },
          responsive: true,
        };

        // ç»˜åˆ¶å›¾è¡¨
        Plotly.newPlot("chartArea2", traces, layout);
      }

      // ç»‘å®šå¼€å§‹åˆ†ææŒ‰é’®äº‹ä»¶
      document.getElementById("analyzeBtn").addEventListener("click", async function () {
        if (!rawData) {
          log("âŒ è¯·å…ˆåŠ è½½æ•°æ®ï¼");
          return;
        }

        try {
          // æ¸…ç©ºä¹‹å‰çš„å›¾è¡¨
          Plotly.purge("chartArea1");
          Plotly.purge("chartArea2");
          document.getElementById("chartArea1").classList.add("hidden");
          document.getElementById("chartArea2").classList.add("hidden");

          // è¿è¡Œç­–ç•¥è®¡ç®—
          const result = runStrategy();
          resultData = result.data;

          // è®¡ç®—Yè½´èŒƒå›´
          const yRanges = calculateYAxisRanges(resultData);

          // ç»˜åˆ¶å›¾è¡¨
          drawReturnChart(resultData, yRanges);
          drawAmountChart(resultData, yRanges);

          // è¾“å‡ºæœ€ç»ˆç»“æœ
          const finalRow = resultData[resultData.length - 1];
          log("\nğŸ“Š ç­–ç•¥åˆ†ææœ€ç»ˆç»“æœï¼š");
          log(`   ä¸€æ¬¡æ€§ä¹°å…¥æ€»æ”¶ç›Šç‡ï¼š${(finalRow["ä¸€æ¬¡æ€§ä¹°å…¥æ”¶ç›Šç‡"] * 100).toFixed(2)}%`);
          log(`   æ™®é€šå®šæŠ•æ€»æ”¶ç›Šç‡ï¼š${(finalRow["æ™®é€šå®šæŠ•æ”¶ç›Šç‡"] * 100).toFixed(2)}%`);
          log(`   åº•ä»“å®šæŠ•æ€»æ”¶ç›Šç‡ï¼š${(finalRow["åº•ä»“å®šæŠ•æ”¶ç›Šç‡"] * 100).toFixed(2)}%`);
          log(`   ä¸€æ¬¡æ€§ä¹°å…¥ç´¯è®¡æ”¶ç›Šï¼š${finalRow["ä¸€æ¬¡æ€§ä¹°å…¥ç´¯è®¡æ”¶ç›Š"].toFixed(2)}å…ƒ`);
          log(`   æ™®é€šå®šæŠ•ç´¯è®¡æ”¶ç›Šï¼š${finalRow["æ™®é€šå®šæŠ•ç´¯è®¡æ”¶ç›Š"].toFixed(2)}å…ƒ`);
          log(`   åº•ä»“å®šæŠ•ç´¯è®¡æ”¶ç›Šï¼š${finalRow["åº•ä»“å®šæŠ•ç´¯è®¡æ”¶ç›Š"].toFixed(2)}å…ƒ`);
          log("\nâœ… æ‰€æœ‰åˆ†æå®Œæˆï¼");
        } catch (err) {
          log(`âŒ åˆ†æå¤±è´¥ï¼š${err.message}`);
          console.error(err);
        }
      });

      // ğŸ”¥ å…³é”®ä¿®æ”¹4ï¼šçª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°ç»˜åˆ¶å›¾è¡¨ï¼Œç¡®ä¿è‡ªé€‚åº”
      window.addEventListener("resize", function() {
        if (resultData) {
          const yRanges = calculateYAxisRanges(resultData);
          Plotly.relayout("chartArea1", { autosize: true });
          Plotly.relayout("chartArea2", { autosize: true });
        }
      });
    </script>
  </body>
</html>